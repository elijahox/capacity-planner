<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Capacity Planner v2 ‚Äî C&S Ecomm Experience</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #f7f6f2;
  --bg2: #eeecea;
  --surface: #ffffff;
  --surface2: #f2f0ec;
  --border: #e0ddd7;
  --border-strong: #ccc9c2;
  --text: #1a1916;
  --text-muted: #7a776e;
  --text-dim: #b0ada5;
  --accent: #1a472a;
  --accent-light: #e8f0eb;
  --accent2: #c17f24;
  --accent2-light: #fdf3e3;
  --red: #c0392b;
  --red-light: #fdf0ee;
  --amber: #d68910;
  --amber-light: #fef9e7;
  --green: #1e8449;
  --green-light: #eafaf1;
  --blue: #1a5276;
  --blue-light: #eaf2fb;
  --purple: #6c3483;
  --purple-light: #f5eef8;
  --tier1: #c0392b;
  --tier2: #c17f24;
  --tier3: #1a5276;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: 'Lato', sans-serif;
  font-size: 14px;
  min-height: 100vh;
}

/* ---- HEADER ---- */
.header {
  background: var(--accent);
  color: #fff;
  padding: 0 32px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  height: 56px;
  position: sticky;
  top: 0;
  z-index: 200;
}
.logo {
  font-family: 'Syne', sans-serif;
  font-weight: 700;
  font-size: 17px;
  letter-spacing: -0.3px;
  color: #fff;
}
.logo span { color: #7ecb96; }
.header-meta {
  font-size: 12px;
  color: rgba(255,255,255,0.55);
  font-family: 'JetBrains Mono', monospace;
  margin-left: 16px;
}
.header-nav { display: flex; gap: 2px; }
.nav-btn {
  padding: 7px 16px;
  border-radius: 6px;
  border: none;
  background: transparent;
  color: rgba(255,255,255,0.65);
  font-family: 'Syne', sans-serif;
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.15s;
  position: relative;
}
.nav-btn:hover { background: rgba(255,255,255,0.1); color: #fff; }
.nav-btn.active { background: rgba(255,255,255,0.15); color: #fff; }
.nav-badge {
  position: absolute;
  top: 4px; right: 6px;
  background: var(--red);
  color: #fff;
  font-size: 9px;
  font-family: 'JetBrains Mono', monospace;
  padding: 1px 4px;
  border-radius: 8px;
  min-width: 16px;
  text-align: center;
}

/* ---- LAYOUT ---- */
.main { display: flex; height: calc(100vh - 56px); }

/* ---- SIDEBAR ---- */
.sidebar {
  width: 256px;
  background: var(--surface);
  border-right: 1px solid var(--border);
  overflow-y: auto;
  flex-shrink: 0;
}
.sidebar-section { border-bottom: 1px solid var(--border); padding: 16px 0 8px; }
.sidebar-label {
  font-size: 10px;
  font-family: 'JetBrains Mono', monospace;
  color: var(--text-dim);
  letter-spacing: 1.5px;
  text-transform: uppercase;
  padding: 0 16px 8px;
}
.tribe-header {
  padding: 8px 16px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  cursor: pointer;
  transition: background 0.1s;
  user-select: none;
}
.tribe-header:hover { background: var(--bg); }
.tribe-name {
  font-family: 'Syne', sans-serif;
  font-size: 12px;
  font-weight: 600;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.8px;
  display: flex;
  align-items: center;
  gap: 6px;
}
.tribe-dot { width: 8px; height: 8px; border-radius: 50%; }
.tribe-count { font-family: 'JetBrains Mono', monospace; font-size: 10px; color: var(--text-dim); }
.squad-item {
  padding: 7px 16px 7px 28px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-left: 3px solid transparent;
  transition: all 0.1s;
}
.squad-item:hover { background: var(--bg); }
.squad-item.active { background: var(--accent-light); border-left-color: var(--accent); }
.squad-item-left { display: flex; align-items: center; gap: 7px; }
.util-pip { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
.squad-item-name { font-size: 13px; }
.squad-item-size {
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px;
  color: var(--text-dim);
  background: var(--bg2);
  padding: 1px 6px;
  border-radius: 8px;
}

/* ---- CONTENT ---- */
.content { flex: 1; overflow-y: auto; padding: 28px 32px; background: var(--bg); }

/* ---- SUMMARY CARDS ---- */
.summary-row { display: grid; grid-template-columns: repeat(5, 1fr); gap: 14px; margin-bottom: 28px; }
.summary-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 16px 18px;
  position: relative;
  overflow: hidden;
}
.summary-card::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 3px;
}
.summary-card.green::before { background: var(--green); }
.summary-card.amber::before { background: var(--amber); }
.summary-card.red::before { background: var(--red); }
.summary-card.blue::before { background: var(--blue); }
.summary-card.purple::before { background: var(--purple); }
.summary-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.6px; margin-bottom: 6px; }
.summary-value { font-family: 'Syne', sans-serif; font-size: 28px; font-weight: 700; line-height: 1; color: var(--text); }
.summary-sub { font-size: 11px; color: var(--text-muted); margin-top: 5px; }

/* ---- SECTION ---- */
.section { margin-bottom: 28px; }
.section-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px; }
.section-title { font-family: 'Syne', sans-serif; font-size: 18px; font-weight: 700; }
.section-sub { font-size: 12px; color: var(--text-muted); margin-top: 2px; }

/* ---- CARD ---- */
.card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 10px;
  overflow: hidden;
}
.card-header {
  padding: 14px 18px;
  border-bottom: 1px solid var(--border);
  background: var(--bg2);
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.card-title { font-family: 'Syne', sans-serif; font-size: 14px; font-weight: 600; }

/* ---- TABLE ---- */
.data-table { width: 100%; border-collapse: collapse; }
.data-table th {
  text-align: left;
  font-size: 10px;
  font-family: 'JetBrains Mono', monospace;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 1px;
  padding: 9px 14px;
  border-bottom: 1px solid var(--border);
  background: var(--bg2);
  white-space: nowrap;
}
.data-table td {
  padding: 10px 14px;
  border-bottom: 1px solid var(--border);
  font-size: 13px;
  vertical-align: middle;
}
.data-table tr:last-child td { border-bottom: none; }
.data-table tbody tr:hover td { background: var(--bg); cursor: pointer; }
.data-table.compact td { padding: 7px 14px; }

/* ---- BADGES ---- */
.badge {
  display: inline-flex;
  align-items: center;
  font-size: 10px;
  font-family: 'JetBrains Mono', monospace;
  padding: 2px 8px;
  border-radius: 4px;
  font-weight: 500;
  white-space: nowrap;
}
.badge-tier1 { background: #fdecea; color: var(--tier1); }
.badge-tier2 { background: var(--amber-light); color: var(--tier2); }
.badge-tier3 { background: var(--blue-light); color: var(--tier3); }
.badge-green { background: var(--green-light); color: var(--green); }
.badge-amber { background: var(--amber-light); color: var(--amber); }
.badge-red { background: var(--red-light); color: var(--red); }
.badge-blue { background: var(--blue-light); color: var(--blue); }
.badge-purple { background: var(--purple-light); color: var(--purple); }
.badge-grey { background: var(--bg2); color: var(--text-muted); border: 1px solid var(--border); }
.badge-perm { background: var(--accent-light); color: var(--accent); }
.badge-contractor { background: var(--amber-light); color: var(--amber); }
.badge-msp { background: var(--purple-light); color: var(--purple); }

/* ---- ALLOCATION BAR ---- */
.alloc-bar-wrap {
  height: 24px;
  background: var(--bg2);
  border-radius: 5px;
  overflow: hidden;
  display: flex;
  border: 1px solid var(--border);
  margin: 10px 0;
}
.alloc-segment {
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 9px;
  font-family: 'JetBrains Mono', monospace;
  overflow: hidden;
  white-space: nowrap;
  transition: filter 0.2s;
  cursor: default;
  flex-shrink: 0;
}
.alloc-segment:hover { filter: brightness(0.9); }
.alloc-legend { display: flex; flex-wrap: wrap; gap: 8px; }
.legend-item { display: flex; align-items: center; gap: 5px; font-size: 11px; color: var(--text-muted); }
.legend-swatch { width: 8px; height: 8px; border-radius: 2px; flex-shrink: 0; }

/* ---- UTIL INDICATOR ---- */
.util-bar-mini { height: 5px; background: var(--bg2); border-radius: 3px; overflow: hidden; margin-top: 8px; }
.util-bar-fill { height: 100%; border-radius: 3px; }

/* ---- OVERVIEW GRID ---- */
.overview-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
.overview-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 16px;
  cursor: pointer;
  transition: all 0.15s;
  position: relative;
}
.overview-card:hover { border-color: var(--accent); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.06); }
.overview-card-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
.overview-card-name { font-family: 'Syne', sans-serif; font-size: 14px; font-weight: 600; }
.overview-card-tribe { font-size: 11px; color: var(--text-muted); margin-top: 2px; }
.overview-card-hc { font-family: 'Syne', sans-serif; font-size: 26px; font-weight: 700; line-height: 1; }
.overview-card-hc-label { font-size: 10px; color: var(--text-dim); }
.overview-card-bottom { display: flex; justify-content: space-between; align-items: center; margin-top: 8px; font-size: 11px; color: var(--text-muted); }
.tribe-stripe { position: absolute; top: 0; left: 0; width: 4px; height: 100%; border-radius: 10px 0 0 10px; }

/* ---- EXPIRY INDICATOR ---- */
.expiry-urgent { color: var(--red); font-weight: 700; }
.expiry-soon { color: var(--amber); font-weight: 600; }
.expiry-ok { color: var(--text-muted); }

/* ---- PERSON CARD (modal-ish detail) ---- */
.person-row-highlight { background: var(--accent-light) !important; }

/* ---- FORMS ---- */
.form-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 16px; }
.form-grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 16px; }
.form-group { display: flex; flex-direction: column; gap: 5px; }
.form-label { font-size: 11px; color: var(--text-muted); font-weight: 600; }
.form-input, .form-select, .form-textarea {
  background: var(--bg);
  border: 1px solid var(--border);
  color: var(--text);
  padding: 8px 11px;
  border-radius: 7px;
  font-family: 'Lato', sans-serif;
  font-size: 13px;
  outline: none;
  transition: border-color 0.15s;
  width: 100%;
}
.form-input:focus, .form-select:focus, .form-textarea:focus { border-color: var(--accent); background: var(--surface); }
.form-select option { background: var(--surface); }
.form-textarea { min-height: 64px; resize: vertical; }

/* ---- BUTTONS ---- */
.btn {
  padding: 8px 16px;
  border-radius: 7px;
  border: none;
  font-family: 'Syne', sans-serif;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.15s;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  white-space: nowrap;
}
.btn-primary { background: var(--accent); color: #fff; }
.btn-primary:hover { background: #145220; }
.btn-secondary { background: var(--surface); color: var(--text); border: 1px solid var(--border); }
.btn-secondary:hover { background: var(--bg2); }
.btn-danger { background: var(--red-light); color: var(--red); border: 1px solid #f5c6c1; }
.btn-danger:hover { background: #fad7d3; }
.btn-amber { background: var(--amber-light); color: var(--amber); border: 1px solid #f8d7a0; }
.btn-sm { padding: 5px 10px; font-size: 11px; border-radius: 5px; }

/* ---- INLINE EDIT ---- */
.inline-edit {
  background: transparent;
  border: none;
  border-bottom: 1px dashed var(--border-strong);
  color: var(--text);
  font-family: 'JetBrains Mono', monospace;
  font-size: 12px;
  width: 52px;
  text-align: center;
  padding: 1px 3px;
  outline: none;
}
.inline-edit:focus { border-bottom-color: var(--accent); background: var(--accent-light); border-radius: 3px 3px 0 0; }

/* ---- TABS ---- */
.tabs { display: flex; gap: 4px; margin-bottom: 18px; border-bottom: 1px solid var(--border); padding-bottom: 0; }
.tab {
  padding: 8px 18px;
  border: none;
  border-bottom: 2px solid transparent;
  background: transparent;
  color: var(--text-muted);
  font-family: 'Syne', sans-serif;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.15s;
  margin-bottom: -1px;
}
.tab:hover { color: var(--text); }
.tab.active { color: var(--accent); border-bottom-color: var(--accent); }

/* ---- ALERT BANNER ---- */
.alert {
  border-radius: 8px;
  padding: 12px 16px;
  margin-bottom: 14px;
  display: flex;
  align-items: flex-start;
  gap: 10px;
  font-size: 13px;
}
.alert-icon { font-size: 16px; flex-shrink: 0; margin-top: 1px; }
.alert-red { background: var(--red-light); border: 1px solid #f5c6c1; color: var(--red); }
.alert-amber { background: var(--amber-light); border: 1px solid #f8d7a0; color: #8a5c00; }
.alert-green { background: var(--green-light); border: 1px solid #a9dfbf; color: var(--green); }
.alert-blue { background: var(--blue-light); border: 1px solid #a9cce3; color: var(--blue); }

/* ---- TAG ---- */
.tag {
  display: inline-flex;
  align-items: center;
  font-size: 10px;
  padding: 2px 7px;
  border-radius: 4px;
  font-family: 'JetBrains Mono', monospace;
  background: var(--bg2);
  color: var(--text-muted);
  border: 1px solid var(--border);
  white-space: nowrap;
}

/* ---- MODAL ---- */
.modal-overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.4);
  z-index: 1000;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px;
}
.modal {
  background: var(--surface);
  border-radius: 14px;
  width: 100%;
  max-width: 680px;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 20px 60px rgba(0,0,0,0.2);
}
.modal-header {
  padding: 20px 24px 16px;
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  background: var(--surface);
  z-index: 1;
}
.modal-title { font-family: 'Syne', sans-serif; font-size: 18px; font-weight: 700; }
.modal-body { padding: 20px 24px; }
.modal-footer { padding: 16px 24px; border-top: 1px solid var(--border); display: flex; gap: 10px; justify-content: flex-end; background: var(--bg2); }
.modal-close { background: none; border: none; font-size: 20px; cursor: pointer; color: var(--text-muted); padding: 4px; line-height: 1; }
.modal-close:hover { color: var(--text); }

/* ---- FINANCIAL PANEL ---- */
.financial-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 14px; margin-bottom: 20px; }
.fin-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 16px 18px;
}
.fin-card-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.6px; margin-bottom: 6px; }
.fin-card-value { font-family: 'Syne', sans-serif; font-size: 24px; font-weight: 700; }
.fin-card-sub { font-size: 11px; color: var(--text-muted); margin-top: 4px; }

/* ---- ROADMAP ---- */
.roadmap-wrap { overflow-x: auto; }
.roadmap-grid {
  display: grid;
  min-width: 900px;
  position: relative;
}
.roadmap-header-row {
  display: flex;
  border-bottom: 2px solid var(--border-strong);
  background: var(--bg2);
  position: sticky;
  top: 0;
  z-index: 10;
}
.roadmap-label-col {
  width: 220px;
  flex-shrink: 0;
  padding: 8px 14px;
  font-size: 11px;
  font-family: 'JetBrains Mono', monospace;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 1px;
  border-right: 1px solid var(--border);
  background: var(--surface);
}
.roadmap-timeline {
  flex: 1;
  display: flex;
  position: relative;
}
.roadmap-month {
  flex: 1;
  padding: 8px 6px;
  font-size: 11px;
  font-family: 'JetBrains Mono', monospace;
  color: var(--text-muted);
  border-right: 1px solid var(--border);
  text-align: center;
  white-space: nowrap;
}
.roadmap-month.quarter-start {
  font-weight: 700;
  color: var(--text);
  border-right: 2px solid var(--border-strong);
}
.roadmap-quarter-label {
  position: absolute;
  top: -22px;
  font-size: 10px;
  font-family: 'JetBrains Mono', monospace;
  color: var(--accent);
  font-weight: 700;
  letter-spacing: 1px;
}
.roadmap-tribe-header {
  display: flex;
  align-items: center;
  border-bottom: 1px solid var(--border);
  background: var(--surface2);
}
.roadmap-tribe-label {
  width: 220px;
  flex-shrink: 0;
  padding: 8px 14px;
  font-family: 'Syne', sans-serif;
  font-size: 12px;
  font-weight: 700;
  border-right: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 7px;
}
.roadmap-tribe-bg { flex: 1; height: 32px; }
.roadmap-row {
  display: flex;
  align-items: center;
  border-bottom: 1px solid var(--border);
  min-height: 40px;
  transition: background 0.1s;
}
.roadmap-row:hover { background: var(--bg); }
.roadmap-row-label {
  width: 220px;
  flex-shrink: 0;
  padding: 6px 14px 6px 26px;
  font-size: 12px;
  color: var(--text);
  border-right: 1px solid var(--border);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  display: flex;
  align-items: center;
  gap: 6px;
}
.roadmap-cells {
  flex: 1;
  position: relative;
  height: 40px;
  display: flex;
}
.roadmap-cell {
  flex: 1;
  border-right: 1px solid var(--border);
  height: 100%;
}
.roadmap-cell.quarter-start { border-right: 2px solid var(--border-strong); }
.roadmap-bar {
  position: absolute;
  top: 7px;
  height: 26px;
  border-radius: 5px;
  display: flex;
  align-items: center;
  padding: 0 8px;
  font-size: 11px;
  font-weight: 600;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  cursor: pointer;
  transition: filter 0.15s, box-shadow 0.15s;
  z-index: 2;
  box-shadow: 0 1px 4px rgba(0,0,0,0.12);
}
.roadmap-bar:hover { filter: brightness(0.92); box-shadow: 0 2px 8px rgba(0,0,0,0.18); }
.today-line {
  position: absolute;
  top: 0; bottom: 0;
  width: 2px;
  background: var(--red);
  z-index: 5;
  pointer-events: none;
}
.today-line::before {
  content: 'Today';
  position: absolute;
  top: -18px;
  left: 4px;
  font-size: 10px;
  color: var(--red);
  font-family: 'JetBrains Mono', monospace;
  font-weight: 700;
}

/* ---- DEMAND CHART ---- */
.demand-chart-wrap { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 20px; margin-bottom: 20px; }
.demand-canvas-wrap { position: relative; }
canvas { display: block; }
.demand-legend { display: flex; flex-wrap: wrap; gap: 14px; margin-top: 14px; }
.demand-legend-item { display: flex; align-items: center; gap: 7px; font-size: 12px; cursor: pointer; }
.demand-legend-swatch { width: 24px; height: 3px; border-radius: 2px; }

/* ---- SCENARIO ---- */
.scenario-panel {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 20px;
  margin-bottom: 20px;
}

/* ---- EMPTY STATE ---- */
.empty { text-align: center; padding: 48px; color: var(--text-muted); }
.empty-icon { font-size: 36px; opacity: 0.4; margin-bottom: 10px; }

/* SCROLLBAR */
::-webkit-scrollbar { width: 5px; height: 5px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border-strong); border-radius: 3px; }

/* TOOLTIP */
[data-tip] { position: relative; }
[data-tip]:hover::after {
  content: attr(data-tip);
  position: absolute; bottom: calc(100% + 5px); left: 50%;
  transform: translateX(-50%);
  background: var(--text); color: #fff;
  font-size: 11px; padding: 4px 8px; border-radius: 5px;
  white-space: nowrap; z-index: 999; pointer-events: none;
}

.divider { height: 1px; background: var(--border); margin: 20px 0; }
</style>
</head>
<body>

<!-- AUTH SCREEN -->
<div id="auth-screen" style="display:none;position:fixed;inset:0;background:#f7f6f2;z-index:1000;align-items:center;justify-content:center">
  <div style="background:#fff;border:1px solid #e0ddd7;border-radius:14px;padding:40px 48px;width:360px;box-shadow:0 8px 40px rgba(0,0,0,0.08);text-align:center">
    <div style="font-family:'Syne',sans-serif;font-size:22px;font-weight:700;margin-bottom:4px">capacity<span style="color:#1a472a">.</span>planner</div>
    <div style="font-size:12px;color:#7a776e;margin-bottom:28px">C&S ¬∑ Ecomm Experience ¬∑ FY26</div>
    <div style="font-size:13px;color:#1a1916;margin-bottom:12px;text-align:left;font-weight:600">Team password</div>
    <input id="auth-input" type="password" placeholder="Enter password"
      style="width:100%;box-sizing:border-box;padding:10px 14px;border:1.5px solid #e0ddd7;border-radius:8px;font-size:14px;font-family:'Lato',sans-serif;outline:none;margin-bottom:10px"
      onkeydown="if(event.key==='Enter')submitAuth()"
      onfocus="this.style.borderColor='#1a472a'" onblur="this.style.borderColor='#e0ddd7'">
    <div id="auth-error" style="display:none;color:#c0392b;font-size:12px;margin-bottom:10px;text-align:left"></div>
    <button id="auth-btn" onclick="submitAuth()"
      style="width:100%;padding:11px;background:#1a472a;color:#fff;border:none;border-radius:8px;font-size:14px;font-family:'Syne',sans-serif;font-weight:600;cursor:pointer">
      Enter
    </button>
  </div>
</div>

<!-- MAIN APP -->
<div id="app-root" style="display:none;flex-direction:column;min-height:100vh">

<div class="header">
  <div style="display:flex;align-items:center;gap:0">
    <div class="logo">capacity<span>.</span>planner</div>
    <div class="header-meta">C&S ¬∑ Ecomm Experience ¬∑ FY26</div>
  </div>
  <div class="header-nav">
    <button class="nav-btn active" onclick="showView('overview',this)">Overview</button>
    <button class="nav-btn" onclick="showView('squads',this)">Squads</button>
    <button class="nav-btn" onclick="showView('people',this)">People Register</button>
    <button class="nav-btn" onclick="showView('contractors',this)" id="contractors-nav">Contractor Watch</button>
    <button class="nav-btn" onclick="showView('initiatives',this)">Initiatives</button>
    <button class="nav-btn" onclick="showView('roadmap',this)">Roadmap</button>
    <button class="nav-btn" onclick="showView('demand',this)">Demand Chart</button>
    <button class="nav-btn" onclick="showView('scenarios',this)">Scenarios</button>
    <button class="nav-btn" onclick="showView('financials',this)">Financials</button>
    <div id="save-indicator" style="font-size:11px;color:#1e8449;font-family:'JetBrains Mono',monospace;opacity:0;transition:opacity 0.4s;margin-left:8px;align-self:center">‚úì Saved</div>
  </div>
</div>

<div class="main">
  <div class="sidebar" id="sidebar"></div>
  <div class="content" id="content"></div>
</div>

</div><!-- end #app-root -->

<!-- MODAL -->
<div class="modal-overlay" id="modal-overlay" style="display:none" onclick="closeModalOnOverlay(event)">
  <div class="modal" id="modal-inner"></div>
</div>

<script>
// ================================================================
// DATA
// ================================================================

const TRIBES = [
  { id:'web',    name:'Web',             color:'#1a5276' },
  { id:'range',  name:'Range',           color:'#1e8449' },
  { id:'app',    name:'App',             color:'#6c3483' },
  { id:'cp',     name:'Cust Platform',   color:'#c17f24' },
];

let squads = [
  {id:'checkout',  tribe:'web',   name:'Checkout',            size:10},
  {id:'payments',  tribe:'web',   name:'Payments',            size:9},
  {id:'discover',  tribe:'web',   name:'Discover & Manage',   size:8},
  {id:'mktplace',  tribe:'range', name:'Marketplace',         size:10},
  {id:'fandc',     tribe:'range', name:'F&C',                 size:10},
  {id:'chatbot',   tribe:'range', name:'Chatbot',             size:7},
  {id:'persloy',   tribe:'range', name:'Pers/Loyalty',        size:7},
  {id:'rocket',    tribe:'range', name:'Rocket',              size:6},
  {id:'ppngcx',    tribe:'app',   name:'PPNG (CX)',           size:8},
  {id:'ppngint',   tribe:'app',   name:'PPNG (Integrations)', size:9},
  {id:'ppinstore', tribe:'app',   name:'PowerPass In-store',  size:5},
  {id:'ppecom',    tribe:'app',   name:'PowerPass eComm',     size:8},
  {id:'findplan',  tribe:'app',   name:'Find & Plan',         size:7},
  {id:'buyman',    tribe:'app',   name:'Buy & Manage',        size:6},
  {id:'sfcrm',     tribe:'cp',    name:'Salesforce CRM',      size:9},
  {id:'ppng_cp',   tribe:'cp',    name:'PPNG',                size:5},
  {id:'nzloy_cp',  tribe:'cp',    name:'NZ Loyalty',          size:5},
];

let initiatives = [
  {id:'ppng',       name:'PPNG',                    tier:1, status:'Delivery',       owner:'C&S', allocations:{ppngcx:100,ppngint:100,ppecom:30,ppinstore:5}},
  {id:'rocket_i',   name:'Project Rocket',           tier:1, status:'Delivery',       owner:'C&S', allocations:{fandc:10,persloy:10,chatbot:100,rocket:100}},
  {id:'nzmkt',      name:'NZ Marketplace',           tier:2, status:'Delivery',       owner:'C&S', allocations:{mktplace:90}},
  {id:'nzloy',      name:'NZ Loyalty',               tier:2, status:'Delivery',       owner:'C&S', allocations:{persloy:10,nzloy_cp:80}},
  {id:'tyrewise',   name:'TyreWise',                 tier:2, status:'Delivery',       owner:'C&S', allocations:{checkout:30}},
  {id:'uteboot',    name:'Ute & Boot Delivery',      tier:2, status:'Delivery',       owner:'C&S', allocations:{checkout:25}},
  {id:'ocean',      name:'Project Ocean',            tier:2, status:'Delivery',       owner:'C&S', allocations:{fandc:15,mktplace:10,payments:10,ppngint:10}},
  {id:'stripe',     name:'Stripe',                   tier:2, status:'Business Case',  owner:'C&S', allocations:{payments:20}},
  {id:'redsba',     name:'Reds in BA',               tier:2, status:'Delivery',       owner:'C&S', allocations:{findplan:20}},
  {id:'ppecom_i',   name:'PP Ecom',                  tier:2, status:'Delivery',       owner:'C&S', allocations:{ppecom:100}},
  {id:'retailmfa',  name:'Retail MFA',               tier:2, status:'Delivery',       owner:'C&S', allocations:{payments:20}},
  {id:'sfcrm_i',    name:'Salesforce CRM',           tier:2, status:'Delivery',       owner:'C&S', allocations:{sfcrm:90}},
  {id:'futsch',     name:'Future of Search',         tier:3, status:'Delivery',       owner:null,  allocations:{fandc:40,mktplace:5}},
  {id:'loyback',    name:'Loyalty Backlog',          tier:3, status:'Delivery',       owner:null,  allocations:{persloy:100}},
  {id:'incident',   name:'Incident Management',      tier:3, status:'Delivery',       owner:null,  allocations:{fandc:5,mktplace:10,chatbot:10,ppinstore:30,findplan:70}},
  {id:'apigee',     name:'APIGEE X Migration',       tier:3, status:'Delivery',       owner:null,  allocations:{fandc:20,mktplace:10,checkout:7,payments:45,discover:35,findplan:50}},
  {id:'futcart',    name:'Future of Cart',           tier:3, status:'Delivery',       owner:null,  allocations:{checkout:20}},
  {id:'crt',        name:'Core Retail Transformation',tier:1,status:'Assess',         owner:null,  allocations:{}},
];

// People register ‚Äî each person has a squadId and type
// type: 'perm' | 'contractor' | 'msp'
let people = [
  // --- WEB / Checkout ---
  {id:'p1',  name:'Jackie Leslie',       squad:'checkout', role:'Delivery Lead',   type:'perm',       dayRate:null,  agency:null,       startDate:'2023-01-10', endDate:null,       status:'active', nextAction:null,   actionStatus:null,   comments:''},
  {id:'p2',  name:'Chris Weall',         squad:'checkout', role:'Delivery Lead',   type:'perm',       dayRate:null,  agency:null,       startDate:'2022-05-01', endDate:null,       status:'active', nextAction:null,   actionStatus:null,   comments:''},
  {id:'p3',  name:'Nick Nguyen',         squad:'checkout', role:'Senior Engineer', type:'contractor', dayRate:1250,  agency:'NCS',      startDate:'2025-03-12', endDate:'2026-03-12', status:'active', nextAction:'Extend', actionStatus:'Approved', comments:'Extension approved til 30th Jun'},
  {id:'p4',  name:'Ian Babic',           squad:'checkout', role:'Senior Engineer', type:'contractor', dayRate:1208,  agency:'AKQA',     startDate:'2024-11-25', endDate:'2026-03-26', status:'active', nextAction:'Roll Off', actionStatus:'Approved', comments:'Changed into a perm TM'},
  {id:'p5',  name:'Berik Assyibekov',    squad:'checkout', role:'Senior Engineer', type:'contractor', dayRate:1250,  agency:'Iterate',  startDate:'2025-01-09', endDate:'2026-06-30', status:'active', nextAction:'Extend', actionStatus:'Approved', comments:''},
  // --- WEB / Payments ---
  {id:'p6',  name:'Fares Isskander',     squad:'payments', role:'Senior Engineer', type:'contractor', dayRate:1250,  agency:'NCS',      startDate:'2024-04-17', endDate:'2026-04-30', status:'active', nextAction:'Extend', actionStatus:null,   comments:''},
  {id:'p7',  name:'Paolo Benini',        squad:'payments', role:'Senior Engineer', type:'contractor', dayRate:1250,  agency:'NCS',      startDate:'2024-04-24', endDate:'2026-04-30', status:'active', nextAction:'Extend', actionStatus:null,   comments:''},
  {id:'p8',  name:'Aditi Thakkar',       squad:'payments', role:'Senior Engineer', type:'contractor', dayRate:1250,  agency:'NCS',      startDate:'2025-03-06', endDate:'2026-04-30', status:'active', nextAction:'Extend', actionStatus:null,   comments:''},
  // --- RANGE / Rocket ---
  {id:'p9',  name:'Michael Dixon',       squad:'rocket',   role:'Engineer',        type:'contractor', dayRate:1200,  agency:'Iterate',  startDate:'2025-02-04', endDate:'2026-08-28', status:'active', nextAction:'Extend', actionStatus:'Approved', comments:'Extension approved til 31st Aug'},
  {id:'p10', name:'Mazhar Morshed',      squad:'rocket',   role:'Senior Engineer', type:'contractor', dayRate:1200,  agency:'RW',       startDate:'2025-01-13', endDate:'2026-08-28', status:'active', nextAction:'Extend', actionStatus:'Approved', comments:'Contract extended til end Aug 2026'},
  {id:'p11', name:'Dylan McLeod',        squad:'rocket',   role:'Tech Lead',       type:'contractor', dayRate:1290,  agency:'Iterate',  startDate:'2025-05-26', endDate:'2026-04-30', status:'active', nextAction:'Extend', actionStatus:'Approved', comments:'Extension approved til 31st Aug'},
  {id:'p12', name:'Jorge Betancur',      squad:'rocket',   role:'Delivery Lead',   type:'contractor', dayRate:1255,  agency:'RW',       startDate:'2025-03-24', endDate:'2026-08-28', status:'active', nextAction:'Extend', actionStatus:'Approved', comments:'Extension approved til 31st Aug'},
  {id:'p13', name:'Ben Shipera',         squad:'rocket',   role:'Business Analyst',type:'contractor', dayRate:1073,  agency:'Preacta',  startDate:'2025-02-04', endDate:'2026-08-28', status:'active', nextAction:'Extend', actionStatus:'Approved', comments:'Extension approved til 31st Aug'},
  {id:'p14', name:'Joseph Jeganathan',   squad:'rocket',   role:'Senior Engineer', type:'contractor', dayRate:1200,  agency:'Iterate',  startDate:'2025-07-28', endDate:'2026-08-28', status:'active', nextAction:'Extend', actionStatus:'Approved', comments:'Extension approved til 31st Aug'},
  {id:'p15', name:'Ramkumar Ranganathan',squad:'rocket',   role:'Quality Engineer',type:'contractor', dayRate:1150,  agency:'Iterate',  startDate:'2025-07-28', endDate:'2026-08-28', status:'active', nextAction:'Extend', actionStatus:'Approved', comments:''},
  // --- APP / PPNG ---
  {id:'p16', name:'Guramarjit Singh',    squad:'ppngcx',   role:'Senior Engineer', type:'contractor', dayRate:1200,  agency:'AKQA',     startDate:'2021-07-21', endDate:'2026-06-30', status:'active', nextAction:'Roll Off', actionStatus:null,  comments:'Roll off after 30th June'},
  {id:'p17', name:'Balan Sinniah',       squad:'ppng_cp',  role:'Senior Engineer', type:'contractor', dayRate:1200,  agency:'NSG',      startDate:'2025-06-01', endDate:'2026-06-30', status:'active', nextAction:'Extend', actionStatus:'Approved', comments:'Extension approved til 30th June'},
  {id:'p18', name:'Karol Koziel',        squad:'ppng_cp',  role:'Senior Engineer', type:'contractor', dayRate:1292,  agency:'NSG',      startDate:'2025-07-04', endDate:'2026-06-30', status:'active', nextAction:'Extend', actionStatus:'Approved', comments:'Extension approved til 30th June'},
  {id:'p19', name:'Pushpraj Samant',     squad:'ppngcx',   role:'Senior Engineer', type:'contractor', dayRate:1180,  agency:'NSG',      startDate:'2025-04-14', endDate:'2026-06-30', status:'active', nextAction:'Extend', actionStatus:'Approved', comments:'Extension approved til 30th June'},
  {id:'p20', name:'Dylan Shaw',          squad:'ppngint',  role:'Senior Engineer', type:'contractor', dayRate:1208,  agency:'AKQA',     startDate:'2025-09-09', endDate:'2026-06-30', status:'active', nextAction:'Extend', actionStatus:'Approved', comments:'Extension approved til 30th June'},
  // --- APP / PowerPass ---
  {id:'p21', name:'Josh Kriesl',         squad:'ppecom',   role:'Senior Engineer', type:'contractor', dayRate:1250,  agency:'NCS',      startDate:'2025-04-25', endDate:'2026-04-30', status:'active', nextAction:'Extend', actionStatus:null,   comments:''},
  {id:'p22', name:'Ray Lewandowski',     squad:'ppecom',   role:'Senior Engineer', type:'msp',        dayRate:1208,  agency:'AKQA',     startDate:'2025-01-07', endDate:'2026-04-30', status:'active', nextAction:'Extend', actionStatus:'Awaiting Approval', comments:''},
  // --- RANGE / Loyalty ---
  {id:'p23', name:'Khalid Elshafie',     squad:'persloy',  role:'Senior Engineer', type:'contractor', dayRate:1250,  agency:'Iterate',  startDate:'2025-02-26', endDate:'2026-06-30', status:'active', nextAction:'Extend', actionStatus:'Approved', comments:''},
  {id:'p24', name:'Armen Avanesi',       squad:'persloy',  role:'Senior Engineer', type:'contractor', dayRate:1200,  agency:'NSG',      startDate:'2026-01-13', endDate:'2026-06-30', status:'active', nextAction:'Extend', actionStatus:'Approved', comments:''},
  {id:'p25', name:'Dinuka Jayamuni',     squad:'persloy',  role:'Tech Lead',       type:'contractor', dayRate:1350,  agency:'Iterate',  startDate:'2025-11-13', endDate:'2026-06-30', status:'active', nextAction:'Extend', actionStatus:'Approved', comments:''},
  // --- CUST PLATFORM / SF ---
  {id:'p26', name:'Brian Lee',           squad:'sfcrm',    role:'Senior Engineer', type:'msp',        dayRate:1200,  agency:'Deloitte', startDate:'2025-10-11', endDate:'2026-04-25', status:'active', nextAction:null,   actionStatus:null,   comments:''},
  {id:'p27', name:'Thomas Clayton',      squad:'sfcrm',    role:'Senior Engineer', type:'msp',        dayRate:1200,  agency:'Deloitte', startDate:'2025-01-12', endDate:'2026-04-25', status:'active', nextAction:null,   actionStatus:null,   comments:''},
  {id:'p28', name:'Yilu Shen',           squad:'sfcrm',    role:'Senior Engineer', type:'msp',        dayRate:1200,  agency:'Deloitte', startDate:'2025-08-01', endDate:'2026-04-25', status:'active', nextAction:null,   actionStatus:null,   comments:''},
  // --- RANGE / Ocean ---
  {id:'p29', name:'Philip Kolar',        squad:'mktplace', role:'Senior Engineer', type:'contractor', dayRate:1250,  agency:'Iterate',  startDate:'2025-03-10', endDate:'2026-06-26', status:'active', nextAction:'New Hire', actionStatus:'Approved', comments:'Re-hire Phil'},
  // --- APP / Find & Plan ---
  {id:'p30', name:'Nikhil Kawatra',      squad:'findplan', role:'Tech Lead',       type:'msp',        dayRate:1200,  agency:'AKQA',     startDate:'2025-11-13', endDate:'2026-03-30', status:'active', nextAction:'Extend', actionStatus:null,   comments:''},
  {id:'p31', name:'Dinesh Shafi',        squad:'fandc',    role:'Quality Engineer',type:'msp',        dayRate:1200,  agency:'AKQA',     startDate:'2025-03-04', endDate:'2026-06-30', status:'active', nextAction:'Extend', actionStatus:null,   comments:''},
];

// Scenario overlays
let scenarios = [];

// ================================================================
// COMPUTED
// ================================================================

function today() { return new Date(); }

function daysUntil(dateStr) {
  if (!dateStr) return Infinity;
  return Math.ceil((new Date(dateStr) - today()) / 86400000);
}

function fmtDate(dateStr) {
  if (!dateStr) return '‚Äî';
  const d = new Date(dateStr);
  return d.toLocaleDateString('en-AU', {day:'numeric',month:'short',year:'2-digit'});
}

function fmtCurrency(n) {
  if (!n) return '‚Äî';
  return '$' + n.toLocaleString();
}

// Headcount for a squad from the people register
function getSquadHeadcount(squadId) {
  return people.filter(p => p.squad === squadId && p.status === 'active').length;
}

// Squad size = people register count (live) + any manual buffer
function getEffectiveSquadSize(squadId) {
  const fromPeople = getSquadHeadcount(squadId);
  const sq = squads.find(s => s.id === squadId);
  // Use whichever is larger (allows manual override, defaults to people count if populated)
  const peopleCount = fromPeople > 0 ? fromPeople : (sq ? sq.size : 0);
  return peopleCount;
}

function getSquadAllocation(squadId) {
  let total = 0;
  let breakdown = [];
  initiatives.forEach(init => {
    const pct = (init.allocations || {})[squadId];
    if (pct > 0) {
      total += pct;
      breakdown.push({ initiative: init, pct });
    }
  });
  scenarios.forEach(s => {
    if (s.squadId === squadId) {
      total += s.delta;
      breakdown.push({ initiative: { id: 'sc_' + s.id, name: '‚ö° ' + s.label, tier: 3, status: 'Delivery' }, pct: s.delta });
    }
  });
  return { total, breakdown };
}

function utilColor(pct) {
  if (pct > 100) return '#c0392b';
  if (pct >= 85)  return '#1e8449';
  if (pct >= 50)  return '#d68910';
  return '#b0ada5';
}

function utilClass(pct) {
  if (pct > 100) return 'badge-red';
  if (pct >= 85)  return 'badge-green';
  if (pct >= 50)  return 'badge-amber';
  return 'badge-grey';
}

function utilLabel(pct) {
  if (pct > 100) return 'Over-allocated';
  if (pct >= 85)  return 'Healthy';
  if (pct >= 50)  return 'Partial';
  return 'Under-utilised';
}

function getTierClass(t) { return ['','badge-tier1','badge-tier2','badge-tier3'][t]||'badge-tier3'; }
function getTierLabel(t) { return ['','T1 Program','T2 Project','T3 Product'][t]||'T3'; }

function getStatusClass(s) {
  return {Delivery:'badge-green','Business Case':'badge-amber',Assess:'badge-purple','High Level Design':'badge-grey'}[s]||'badge-grey';
}

function getExpiryClass(d) {
  const days = daysUntil(d);
  if (days < 0) return 'expiry-urgent';
  if (days <= 14) return 'expiry-urgent';
  if (days <= 45) return 'expiry-soon';
  return 'expiry-ok';
}

function getExpiryLabel(d) {
  const days = daysUntil(d);
  if (days < 0) return `Expired ${Math.abs(days)}d ago`;
  if (days === 0) return 'Expires today';
  if (days <= 14) return `${days}d left ‚ö†Ô∏è`;
  if (days <= 45) return `${days}d left`;
  return fmtDate(d);
}

function getTypeClass(t) {
  return { perm: 'badge-perm', contractor: 'badge-contractor', msp: 'badge-msp' }[t] || 'badge-grey';
}
function getTypeLabel(t) {
  return { perm: 'Permanent', contractor: 'Contractor', msp: 'Consultant (MSP)' }[t] || t;
}

function getActionClass(a) {
  return { Extend: 'badge-green', 'Roll Off': 'badge-red', Convert: 'badge-amber', 'New Hire': 'badge-blue' }[a] || 'badge-grey';
}

const SEG_COLORS = ['#1a5276','#1e8449','#6c3483','#c17f24','#c0392b','#148f77','#7d3c98','#d35400','#1a5276','#7f8c8d','#2980b9','#27ae60'];

function getContractorsExpiringSoon(days = 30) {
  return people.filter(p => p.type !== 'perm' && p.status === 'active' && daysUntil(p.endDate) <= days && daysUntil(p.endDate) >= 0);
}

function getTotalDailySpend() {
  return people.filter(p => p.type !== 'perm' && p.status === 'active' && p.dayRate)
    .reduce((a, p) => a + p.dayRate, 0);
}

// ================================================================
// SIDEBAR
// ================================================================

let currentView = 'overview';
let selectedSquad = null;
let collapsedTribes = {};

function renderSidebar() {
  const el = document.getElementById('sidebar');
  let html = '';
  TRIBES.forEach(tribe => {
    const tribeSquads = squads.filter(s => s.tribe === tribe.id);
    const totalHC = tribeSquads.reduce((a, s) => a + getEffectiveSquadSize(s.id), 0);
    const isCollapsed = collapsedTribes[tribe.id];
    html += `<div class="sidebar-section">
      <div class="tribe-header" onclick="toggleTribe('${tribe.id}')">
        <div class="tribe-name">
          <div class="tribe-dot" style="background:${tribe.color}"></div>${tribe.name}
        </div>
        <span class="tribe-count">${totalHC}p</span>
      </div>`;
    if (!isCollapsed) {
      tribeSquads.forEach(sq => {
        const { total } = getSquadAllocation(sq.id);
        const active = selectedSquad === sq.id && currentView === 'squads' ? 'active' : '';
        html += `<div class="squad-item ${active}" onclick="goToSquad('${sq.id}')">
          <div class="squad-item-left">
            <div class="util-pip" style="background:${utilColor(total)}"></div>
            <span class="squad-item-name">${sq.name}</span>
          </div>
          <span class="squad-item-size">${getEffectiveSquadSize(sq.id)}</span>
        </div>`;
      });
    }
    html += '</div>';
  });
  el.innerHTML = html;

  // Update contractor watch badge
  const urgent = getContractorsExpiringSoon(30).length;
  const navBtn = document.getElementById('contractors-nav');
  if (navBtn) {
    const existing = navBtn.querySelector('.nav-badge');
    if (existing) existing.remove();
    if (urgent > 0) navBtn.innerHTML += `<span class="nav-badge">${urgent}</span>`;
  }
}

function toggleTribe(id) { collapsedTribes[id] = !collapsedTribes[id]; renderSidebar(); }

function goToSquad(id) {
  selectedSquad = id;
  currentView = 'squads';
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.nav-btn')[1].classList.add('active');
  renderContent();
  renderSidebar();
}

// ================================================================
// VIEW ROUTER
// ================================================================

function showView(view, btn) {
  currentView = view;
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
  renderContent();
  renderSidebar();
}

function renderContent() {
  const views = {
    overview: renderOverview,
    squads: renderSquads,
    people: renderPeople,
    contractors: renderContractorWatch,
    initiatives: renderInitiatives,
    roadmap: renderRoadmap,
    demand: renderDemand,
    financials: renderFinancials,
  };
  document.getElementById('content').innerHTML = (views[currentView] || renderOverview)();
  scheduleSave();
}

// ================================================================
// OVERVIEW
// ================================================================

function renderOverview() {
  const totalHC = squads.reduce((a, s) => a + getEffectiveSquadSize(s.id), 0);
  const totalContractors = people.filter(p => p.type !== 'perm' && p.status === 'active').length;
  const overAlloc = squads.filter(s => getSquadAllocation(s.id).total > 100).length;
  const expiring30 = getContractorsExpiringSoon(30).length;
  const avgUtil = squads.reduce((a, s) => a + getSquadAllocation(s.id).total, 0) / squads.length;
  const dailySpend = getTotalDailySpend();

  let html = `
    <div class="summary-row">
      <div class="summary-card green">
        <div class="summary-label">Total Headcount</div>
        <div class="summary-value">${totalHC}</div>
        <div class="summary-sub">${squads.length} squads ¬∑ ${TRIBES.length} tribes</div>
      </div>
      <div class="summary-card blue">
        <div class="summary-label">Avg Utilisation</div>
        <div class="summary-value" style="color:${utilColor(avgUtil)}">${Math.round(avgUtil)}%</div>
        <div class="summary-sub">across all squads</div>
      </div>
      <div class="summary-card ${overAlloc > 0 ? 'red' : 'green'}">
        <div class="summary-label">Over-allocated</div>
        <div class="summary-value" style="color:${overAlloc > 0 ? 'var(--red)' : 'var(--green)'}">${overAlloc}</div>
        <div class="summary-sub">${overAlloc > 0 ? 'squads need attention' : 'All within capacity'}</div>
      </div>
      <div class="summary-card ${expiring30 > 0 ? 'amber' : 'green'}">
        <div class="summary-label">Contracts Expiring</div>
        <div class="summary-value" style="color:${expiring30 > 0 ? 'var(--amber)' : 'var(--green)'}">${expiring30}</div>
        <div class="summary-sub">within next 30 days</div>
      </div>
      <div class="summary-card purple">
        <div class="summary-label">Daily Contractor Spend</div>
        <div class="summary-value" style="font-size:20px">${fmtCurrency(dailySpend)}</div>
        <div class="summary-sub">${totalContractors} active contractors/MSPs</div>
      </div>
    </div>`;

  // Alerts
  const expired = people.filter(p => p.type !== 'perm' && p.status === 'active' && daysUntil(p.endDate) < 0);
  const urgent14 = getContractorsExpiringSoon(14);
  if (expired.length) html += `<div class="alert alert-red"><div class="alert-icon">üö®</div><div><strong>${expired.length} contractor(s) have expired contracts</strong> ‚Äî ${expired.map(p=>p.name).join(', ')}. Action required immediately.</div></div>`;
  if (urgent14.length) html += `<div class="alert alert-amber"><div class="alert-icon">‚ö†Ô∏è</div><div><strong>${urgent14.length} contractor(s) expire within 14 days</strong> ‚Äî ${urgent14.map(p=>p.name).join(', ')}. Review and decide on extension or roll-off.</div></div>`;
  if (overAlloc > 0) html += `<div class="alert alert-amber"><div class="alert-icon">üìä</div><div><strong>${overAlloc} squad(s) are over-allocated.</strong> Go to Squads view to review and rebalance initiative assignments.</div></div>`;

  // Tribe grids
  TRIBES.forEach(tribe => {
    const tribeSquads = squads.filter(s => s.tribe === tribe.id);
    html += `<div class="section">
      <div class="section-header">
        <div>
          <div class="section-title" style="display:flex;align-items:center;gap:8px">
            <div style="width:10px;height:10px;border-radius:50%;background:${tribe.color}"></div>${tribe.name} Tribe
          </div>
          <div class="section-sub">${tribeSquads.reduce((a,s)=>a+getEffectiveSquadSize(s.id),0)} people ¬∑ ${tribeSquads.length} squads</div>
        </div>
      </div>
      <div class="overview-grid">`;
    tribeSquads.forEach(sq => {
      const { total, breakdown } = getSquadAllocation(sq.id);
      const hc = getEffectiveSquadSize(sq.id);
      const sqPeople = people.filter(p => p.squad === sq.id && p.status === 'active');
      const contractors = sqPeople.filter(p => p.type !== 'perm').length;
      html += `<div class="overview-card" onclick="goToSquad('${sq.id}')">
        <div class="tribe-stripe" style="background:${tribe.color}"></div>
        <div class="overview-card-top">
          <div>
            <div class="overview-card-name">${sq.name}</div>
            <div class="overview-card-tribe">${tribe.name}</div>
          </div>
          <div style="text-align:right">
            <div class="overview-card-hc">${hc}</div>
            <div class="overview-card-hc-label">people</div>
          </div>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center">
          <span class="badge ${utilClass(total)}">${Math.round(total)}% utilised</span>
          <span style="font-size:11px;color:var(--text-muted)">${contractors} contractor${contractors !== 1 ? 's' : ''}</span>
        </div>
        <div class="util-bar-mini"><div class="util-bar-fill" style="width:${Math.min(total,110)}%;background:${utilColor(total)}"></div></div>
      </div>`;
    });
    html += '</div></div>';
  });
  return html;
}

// ================================================================
// SQUADS VIEW
// ================================================================

function renderSquads() {
  if (!selectedSquad) selectedSquad = squads[0].id;
  const sq = squads.find(s => s.id === selectedSquad);
  if (!sq) return '';
  const tribe = TRIBES.find(t => t.id === sq.tribe);
  const { total, breakdown } = getSquadAllocation(sq.id);
  const sqPeople = people.filter(p => p.squad === sq.id && p.status === 'active');
  const hc = sqPeople.length > 0 ? sqPeople.length : sq.size;

  // Build allocation bar
  let barSegs = '', legend = '';
  breakdown.forEach((item, i) => {
    const col = SEG_COLORS[i % SEG_COLORS.length];
    const w = Math.min(item.pct, 100);
    const lbl = item.pct >= 10 ? `${item.pct}%` : '';
    barSegs += `<div class="alloc-segment" style="width:${w}%;background:${col};flex-shrink:0" data-tip="${item.initiative.name}: ${item.pct}%">${lbl}</div>`;
    legend += `<div class="legend-item"><div class="legend-swatch" style="background:${col}"></div>${item.initiative.name}</div>`;
  });
  const rem = Math.max(0, 100 - total);
  if (rem > 0) barSegs += `<div class="alloc-segment" style="flex:1;background:var(--bg2);color:var(--text-dim)">${rem >= 8 ? rem+'%' : ''}</div>`;

  let html = `
    <div style="display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:20px">
      <div>
        <div style="font-family:'Syne',sans-serif;font-size:22px;font-weight:700;display:flex;align-items:center;gap:10px">
          <div style="width:12px;height:12px;border-radius:50%;background:${tribe.color}"></div>${sq.name}
        </div>
        <div style="font-size:12px;color:var(--text-muted);margin-top:3px">${tribe.name} Tribe ¬∑ ${hc} people ¬∑ ${sqPeople.filter(p=>p.type!=='perm').length} contractors</div>
      </div>
      <button class="btn btn-primary btn-sm" onclick="openAddPersonModal('${sq.id}')">+ Add Person</button>
    </div>

    <div class="card" style="margin-bottom:20px">
      <div class="card-header">
        <div class="card-title">Capacity Allocation</div>
        <span class="badge ${utilClass(total)}">${utilLabel(total)} ‚Äî ${Math.round(total)}%</span>
      </div>
      <div style="padding:16px 18px">
        <div class="alloc-bar-wrap">${barSegs}</div>
        <div class="alloc-legend">${legend}</div>
        <div style="display:flex;gap:20px;margin-top:14px;font-size:12px;color:var(--text-muted)">
          <span>Allocated: <strong style="color:${utilColor(total)}">${Math.round(total)}%</strong></span>
          <span>Free: <strong>${rem}%</strong></span>
          <span>Headcount: <strong>${hc}</strong></span>
          <span>~People on active work: <strong>${(total/100*hc).toFixed(1)}</strong></span>
        </div>
      </div>
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
      <div class="section">
        <div class="section-header">
          <div class="section-title" style="font-size:16px">Initiative Allocations</div>
          <button class="btn btn-secondary btn-sm" onclick="openAddAllocationModal('${sq.id}')">+ Add</button>
        </div>
        <div class="card">
          <table class="data-table">
            <thead><tr><th>Initiative</th><th>Tier</th><th>%</th><th>~Ppl</th><th></th></tr></thead>
            <tbody>
              ${breakdown.length === 0 ? '<tr><td colspan="5" style="text-align:center;color:var(--text-muted);padding:24px">No allocations</td></tr>' : ''}
              ${breakdown.map((item, i) => `<tr>
                <td><strong>${item.initiative.name}</strong></td>
                <td><span class="badge ${getTierClass(item.initiative.tier)}">${getTierLabel(item.initiative.tier)}</span></td>
                <td><input class="inline-edit" type="number" value="${item.pct}" min="0" max="100" onchange="updateAlloc('${item.initiative.id}','${sq.id}',this.value)" /></td>
                <td style="font-family:'JetBrains Mono',monospace;color:var(--text-muted)">${(item.pct/100*hc).toFixed(1)}</td>
                <td><button class="btn btn-danger btn-sm" onclick="removeAlloc('${item.initiative.id}','${sq.id}')">‚úï</button></td>
              </tr>`).join('')}
            </tbody>
          </table>
        </div>
        ${total > 100 ? `<div class="alert alert-red" style="margin-top:12px"><div class="alert-icon">‚ö†Ô∏è</div><div><strong>Over-allocated by ${Math.round(total-100)}%</strong> ‚Äî review and rebalance initiatives.</div></div>` : ''}
      </div>

      <div class="section">
        <div class="section-header">
          <div class="section-title" style="font-size:16px">People in Squad</div>
        </div>
        <div class="card">
          <table class="data-table compact">
            <thead><tr><th>Name</th><th>Role</th><th>Type</th><th>End Date</th></tr></thead>
            <tbody>
              ${sqPeople.length === 0 ? '<tr><td colspan="4" style="text-align:center;color:var(--text-muted);padding:20px">No people linked yet</td></tr>' : ''}
              ${sqPeople.map(p => `<tr onclick="openPersonModal('${p.id}')">
                <td><strong>${p.name}</strong></td>
                <td style="color:var(--text-muted)">${p.role}</td>
                <td><span class="badge ${getTypeClass(p.type)}">${getTypeLabel(p.type)}</span></td>
                <td class="${p.endDate ? getExpiryClass(p.endDate) : ''}">${p.endDate ? getExpiryLabel(p.endDate) : '‚Äî'}</td>
              </tr>`).join('')}
            </tbody>
          </table>
        </div>
      </div>
    </div>`;
  return html;
}

// ================================================================
// PEOPLE REGISTER
// ================================================================

function renderPeople() {
  const filter = document.getElementById('people-type-filter')?.value || 'all';

  let filtered = people.filter(p => p.status === 'active');
  if (filter === 'perm') filtered = filtered.filter(p => p.type === 'perm');
  if (filter === 'contractor') filtered = filtered.filter(p => p.type === 'contractor');
  if (filter === 'msp') filtered = filtered.filter(p => p.type === 'msp');

  return `
    <div class="section-header">
      <div>
        <div class="section-title">People Register</div>
        <div class="section-sub">${people.filter(p=>p.status==='active').length} active people across all squads</div>
      </div>
      <div style="display:flex;gap:10px;align-items:center">
        <select class="form-select" style="width:180px" id="people-type-filter" onchange="renderContent()">
          <option value="all">All types</option>
          <option value="perm">Permanent only</option>
          <option value="contractor">Contractors only</option>
          <option value="msp">MSP/Consultants only</option>
        </select>
        <button class="btn btn-primary btn-sm" onclick="openAddPersonModal(null)">+ Add Person</button>
      </div>
    </div>
    <div class="card">
      <table class="data-table">
        <thead><tr><th>Name</th><th>Role</th><th>Squad</th><th>Tribe</th><th>Type</th><th>Day Rate</th><th>Agency</th><th>End Date</th><th>Next Action</th><th>Action Status</th></tr></thead>
        <tbody>
          ${filtered.map(p => {
            const sq = squads.find(s => s.id === p.squad);
            const tribe = sq ? TRIBES.find(t => t.id === sq.tribe) : null;
            return `<tr onclick="openPersonModal('${p.id}')">
              <td><strong>${p.name}</strong></td>
              <td style="color:var(--text-muted)">${p.role}</td>
              <td>${sq ? sq.name : '‚Äî'}</td>
              <td>${tribe ? `<span style="display:flex;align-items:center;gap:5px"><div style="width:7px;height:7px;border-radius:50%;background:${tribe.color}"></div>${tribe.name}</span>` : '‚Äî'}</td>
              <td><span class="badge ${getTypeClass(p.type)}">${getTypeLabel(p.type)}</span></td>
              <td style="font-family:'JetBrains Mono',monospace">${fmtCurrency(p.dayRate)}</td>
              <td>${p.agency || '‚Äî'}</td>
              <td class="${p.endDate ? getExpiryClass(p.endDate) : ''}">${p.endDate ? getExpiryLabel(p.endDate) : '‚Äî'}</td>
              <td>${p.nextAction ? `<span class="badge ${getActionClass(p.nextAction)}">${p.nextAction}</span>` : '‚Äî'}</td>
              <td>${p.actionStatus ? `<span class="badge badge-grey">${p.actionStatus}</span>` : '‚Äî'}</td>
            </tr>`;
          }).join('')}
        </tbody>
      </table>
    </div>`;
}

// ================================================================
// CONTRACTOR WATCH
// ================================================================

function renderContractorWatch() {
  const active = people.filter(p => p.type !== 'perm' && p.status === 'active');
  const expired = active.filter(p => daysUntil(p.endDate) < 0);
  const within14 = active.filter(p => daysUntil(p.endDate) >= 0 && daysUntil(p.endDate) <= 14);
  const within30 = active.filter(p => daysUntil(p.endDate) > 14 && daysUntil(p.endDate) <= 30);
  const within90 = active.filter(p => daysUntil(p.endDate) > 30 && daysUntil(p.endDate) <= 90);
  const healthy  = active.filter(p => daysUntil(p.endDate) > 90);

  const byAgency = {};
  active.forEach(p => {
    if (!p.agency) return;
    if (!byAgency[p.agency]) byAgency[p.agency] = { count: 0, spend: 0 };
    byAgency[p.agency].count++;
    byAgency[p.agency].spend += (p.dayRate || 0);
  });

  function contractorTable(list, emptyMsg) {
    if (!list.length) return `<div class="empty" style="padding:20px"><div class="empty-icon">‚úì</div><div>${emptyMsg}</div></div>`;
    return `<table class="data-table compact">
      <thead><tr><th>Name</th><th>Role</th><th>Squad</th><th>Type</th><th>Day Rate</th><th>Agency</th><th>End Date</th><th>Next Action</th><th>Action Status</th><th>Comments</th></tr></thead>
      <tbody>
        ${list.map(p => {
          const sq = squads.find(s => s.id === p.squad);
          return `<tr onclick="openPersonModal('${p.id}')">
            <td><strong>${p.name}</strong></td>
            <td style="color:var(--text-muted)">${p.role}</td>
            <td>${sq ? sq.name : '‚Äî'}</td>
            <td><span class="badge ${getTypeClass(p.type)}">${getTypeLabel(p.type)}</span></td>
            <td style="font-family:'JetBrains Mono',monospace">${fmtCurrency(p.dayRate)}</td>
            <td>${p.agency || '‚Äî'}</td>
            <td class="${getExpiryClass(p.endDate)}">${getExpiryLabel(p.endDate)}</td>
            <td>${p.nextAction ? `<span class="badge ${getActionClass(p.nextAction)}">${p.nextAction}</span>` : '‚Äî'}</td>
            <td>${p.actionStatus ? `<span class="badge badge-grey">${p.actionStatus}</span>` : '‚Äî'}</td>
            <td style="max-width:200px;font-size:11px;color:var(--text-muted)">${p.comments || ''}</td>
          </tr>`;
        }).join('')}
      </tbody>
    </table>`;
  }

  return `
    <div class="section-header">
      <div>
        <div class="section-title">Contractor Watch</div>
        <div class="section-sub">${active.length} active contractors & consultants ‚Äî click any row to edit</div>
      </div>
    </div>

    ${expired.length ? `<div class="alert alert-red"><div class="alert-icon">üö®</div><div><strong>${expired.length} expired contract(s)</strong> ‚Äî immediate action required.</div></div>` : ''}
    ${within14.length ? `<div class="alert alert-amber"><div class="alert-icon">‚ö†Ô∏è</div><div><strong>${within14.length} contract(s) expire within 14 days</strong> ‚Äî review now.</div></div>` : ''}

    <div class="tabs">
      <button class="tab active" onclick="switchCWTab(event,'cw-expired')">Expired (${expired.length})</button>
      <button class="tab" onclick="switchCWTab(event,'cw-14')">Next 14 days (${within14.length})</button>
      <button class="tab" onclick="switchCWTab(event,'cw-30')">15‚Äì30 days (${within30.length})</button>
      <button class="tab" onclick="switchCWTab(event,'cw-90')">31‚Äì90 days (${within90.length})</button>
      <button class="tab" onclick="switchCWTab(event,'cw-ok')">90+ days (${healthy.length})</button>
    </div>

    <div id="cw-expired" class="cw-panel card" style="margin-bottom:20px">${contractorTable(expired, 'No expired contracts')}</div>
    <div id="cw-14" class="cw-panel card" style="margin-bottom:20px;display:none">${contractorTable(within14, 'No contracts expiring in the next 14 days')}</div>
    <div id="cw-30" class="cw-panel card" style="margin-bottom:20px;display:none">${contractorTable(within30, 'No contracts expiring in 15‚Äì30 days')}</div>
    <div id="cw-90" class="cw-panel card" style="margin-bottom:20px;display:none">${contractorTable(within90, 'No contracts in 31‚Äì90 day window')}</div>
    <div id="cw-ok" class="cw-panel card" style="margin-bottom:20px;display:none">${contractorTable(healthy, 'No contracts in 90+ day window')}</div>

    <div class="section-header" style="margin-top:8px"><div class="section-title" style="font-size:16px">By Agency</div></div>
    <div class="card">
      <table class="data-table compact">
        <thead><tr><th>Agency</th><th>Contractors</th><th>Daily Spend</th><th>Est. Monthly</th></tr></thead>
        <tbody>
          ${Object.entries(byAgency).sort((a,b)=>b[1].spend-a[1].spend).map(([agency,data]) => `<tr>
            <td><strong>${agency}</strong></td>
            <td style="font-family:'JetBrains Mono',monospace">${data.count}</td>
            <td style="font-family:'JetBrains Mono',monospace">${fmtCurrency(data.spend)}</td>
            <td style="font-family:'JetBrains Mono',monospace;color:var(--text-muted)">${fmtCurrency(data.spend * 21)}</td>
          </tr>`).join('')}
          <tr style="border-top:2px solid var(--border)">
            <td><strong>Total</strong></td>
            <td style="font-family:'JetBrains Mono',monospace"><strong>${active.length}</strong></td>
            <td style="font-family:'JetBrains Mono',monospace"><strong>${fmtCurrency(getTotalDailySpend())}</strong></td>
            <td style="font-family:'JetBrains Mono',monospace"><strong>${fmtCurrency(getTotalDailySpend()*21)}</strong></td>
          </tr>
        </tbody>
      </table>
    </div>`;
}

function switchCWTab(event, panelId) {
  document.querySelectorAll('.cw-panel').forEach(p => p.style.display = 'none');
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById(panelId).style.display = 'block';
  event.target.classList.add('active');
}

// ================================================================
// INITIATIVES VIEW
// ================================================================

function renderInitiatives() {
  const tiers = [1,2,3];
  return `
    <div class="section-header">
      <div>
        <div class="section-title">Initiatives</div>
        <div class="section-sub">${initiatives.length} total</div>
      </div>
      <button class="btn btn-primary btn-sm" onclick="openAddInitiativeModal()">+ New Initiative</button>
    </div>
    ${tiers.map(tier => {
      const list = initiatives.filter(i => i.tier === tier);
      return `
      <div class="section">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
          <span class="badge ${getTierClass(tier)}">${getTierLabel(tier)}</span>
          <span style="font-size:12px;color:var(--text-muted)">${list.length} initiatives</span>
        </div>
        <div class="card">
          <table class="data-table">
            <thead><tr><th>Initiative</th><th>Status</th><th>Owner</th><th>Squads</th><th>People Equiv.</th><th>Daily Cost</th></tr></thead>
            <tbody>
              ${list.map(init => {
                const allocs = Object.entries(init.allocations||{}).filter(([,v])=>v>0);
                const totalPpl = allocs.reduce((acc,[sqId,pct]) => {
                  const sq = squads.find(s=>s.id===sqId);
                  return acc + (sq ? pct/100*getEffectiveSquadSize(sq.id) : 0);
                }, 0);
                // Rough daily cost: sum contractors in those squads proportionally
                const dailyCost = allocs.reduce((acc,[sqId,pct]) => {
                  const sqConts = people.filter(p=>p.squad===sqId&&p.type!=='perm'&&p.status==='active'&&p.dayRate);
                  return acc + sqConts.reduce((a,p)=>a+p.dayRate*(pct/100),0);
                },0);
                return `<tr>
                  <td><strong>${init.name}</strong></td>
                  <td><span class="badge ${getStatusClass(init.status)}">${init.status}</span></td>
                  <td style="color:var(--text-muted)">${init.owner||'‚Äî'}</td>
                  <td>
                    <div style="display:flex;flex-wrap:wrap;gap:4px">
                      ${allocs.slice(0,3).map(([sqId,pct])=>{const sq=squads.find(s=>s.id===sqId);return sq?`<span class="tag">${sq.name} ${pct}%</span>`:''}).join('')}
                      ${allocs.length>3?`<span class="tag">+${allocs.length-3}</span>`:''}
                      ${allocs.length===0?'<span style="color:var(--text-dim)">None</span>':''}
                    </div>
                  </td>
                  <td style="font-family:'JetBrains Mono',monospace">${totalPpl.toFixed(1)}</td>
                  <td style="font-family:'JetBrains Mono',monospace;color:var(--text-muted)">${dailyCost>0?fmtCurrency(Math.round(dailyCost)):'‚Äî'}</td>
                </tr>`;
              }).join('')}
            </tbody>
          </table>
        </div>
      </div>`;
    }).join('')}`;
}

// ================================================================
// SCENARIOS
// ================================================================

function renderScenarios() {
  return `
    <div class="section-header">
      <div>
        <div class="section-title">Scenario Modelling</div>
        <div class="section-sub">Model "what if" changes and see impact across all squads</div>
      </div>
    </div>

    <div class="scenario-panel" style="margin-bottom:20px">
      <div style="font-family:'Syne',sans-serif;font-weight:600;margin-bottom:14px">‚ö° Add Scenario Change</div>
      <div class="form-grid">
        <div class="form-group">
          <div class="form-label">Squad</div>
          <select class="form-select" id="sc-squad">
            ${squads.map(s=>`<option value="${s.id}">${s.name}</option>`).join('')}
          </select>
        </div>
        <div class="form-group">
          <div class="form-label">Change Type</div>
          <select class="form-select" id="sc-type">
            <option value="alloc_add">Add initiative allocation %</option>
            <option value="alloc_remove">Remove initiative allocation %</option>
            <option value="hire">Add headcount (hire)</option>
            <option value="lose">Lose headcount (roll-off/leave)</option>
          </select>
        </div>
        <div class="form-group">
          <div class="form-label">Amount (% or people)</div>
          <input class="form-input" id="sc-amount" type="number" min="0" max="100" placeholder="e.g. 20" />
        </div>
      </div>
      <div class="form-grid-2">
        <div class="form-group">
          <div class="form-label">Label / Description</div>
          <input class="form-input" id="sc-label" placeholder="e.g. Rocket extension, 2 new hires" />
        </div>
        <div style="display:flex;align-items:flex-end">
          <button class="btn btn-primary" onclick="applyScenario()" style="width:100%">Apply Scenario ‚Üí</button>
        </div>
      </div>
    </div>

    ${scenarios.length > 0 ? `
    <div class="card" style="margin-bottom:20px">
      <div class="card-header">
        <div class="card-title">Active Scenarios (${scenarios.length})</div>
        <button class="btn btn-danger btn-sm" onclick="clearScenarios()">Clear All</button>
      </div>
      <table class="data-table">
        <thead><tr><th>Squad</th><th>Change</th><th>Delta</th><th>Before</th><th>After</th><th></th></tr></thead>
        <tbody>
          ${scenarios.map((s,i) => {
            const sq = squads.find(q=>q.id===s.squadId);
            const { total } = getSquadAllocation(s.squadId);
            const before = total - s.delta;
            return `<tr>
              <td><strong>${sq?sq.name:s.squadId}</strong></td>
              <td style="color:var(--text-muted)">${s.label}</td>
              <td style="font-family:'JetBrains Mono',monospace;color:${s.delta>0?'var(--red)':'var(--green)'}">${s.delta>0?'+':''}${s.delta}%</td>
              <td style="font-family:'JetBrains Mono',monospace">${Math.round(before)}%</td>
              <td><span class="badge ${utilClass(total)}">${Math.round(total)}%</span></td>
              <td><button class="btn btn-danger btn-sm" onclick="removeScenario(${i})">‚úï</button></td>
            </tr>`;
          }).join('')}
        </tbody>
      </table>
    </div>` : ''}

    <div class="section-title" style="font-family:'Syne',sans-serif;font-weight:700;margin-bottom:14px">Snapshot ‚Äî All Squads</div>
    <div class="card">
      <table class="data-table">
        <thead><tr><th>Squad</th><th>Tribe</th><th>Headcount</th><th>Contractors</th><th>Utilisation</th><th>Status</th></tr></thead>
        <tbody>
          ${squads.map(sq => {
            const { total } = getSquadAllocation(sq.id);
            const tribe = TRIBES.find(t=>t.id===sq.tribe);
            const hc = getEffectiveSquadSize(sq.id);
            const conts = people.filter(p=>p.squad===sq.id&&p.type!=='perm'&&p.status==='active').length;
            return `<tr>
              <td><strong>${sq.name}</strong></td>
              <td><span style="display:flex;align-items:center;gap:5px"><div style="width:7px;height:7px;border-radius:50%;background:${tribe.color}"></div>${tribe.name}</span></td>
              <td style="font-family:'JetBrains Mono',monospace">${hc}</td>
              <td style="font-family:'JetBrains Mono',monospace">${conts}</td>
              <td>
                <div style="display:flex;align-items:center;gap:10px">
                  <div style="width:80px;height:5px;background:var(--bg2);border-radius:3px;overflow:hidden">
                    <div style="width:${Math.min(total,100)}%;height:100%;background:${utilColor(total)};border-radius:3px"></div>
                  </div>
                  <span style="font-family:'JetBrains Mono',monospace;font-size:12px">${Math.round(total)}%</span>
                </div>
              </td>
              <td><span class="badge ${utilClass(total)}">${utilLabel(total)}</span></td>
            </tr>`;
          }).join('')}
        </tbody>
      </table>
    </div>`;
}

// ================================================================
// FINANCIALS
// ================================================================

function renderFinancials() {
  const active = people.filter(p=>p.type!=='perm'&&p.status==='active'&&p.dayRate);
  const daily = active.reduce((a,p)=>a+p.dayRate,0);
  const monthly = daily * 21;
  const annual = daily * 252;

  const byRole = {};
  active.forEach(p => {
    if (!byRole[p.role]) byRole[p.role] = { count:0, total:0 };
    byRole[p.role].count++;
    byRole[p.role].total += p.dayRate;
  });

  return `
    <div class="section-header">
      <div>
        <div class="section-title">Financial Overview</div>
        <div class="section-sub">Contractor & consultant cost exposure ‚Äî permanent salaries not included</div>
      </div>
    </div>

    <div class="financial-grid">
      <div class="fin-card">
        <div class="fin-card-label">Daily Spend</div>
        <div class="fin-card-value">${fmtCurrency(daily)}</div>
        <div class="fin-card-sub">${active.length} active contractors/MSPs</div>
      </div>
      <div class="fin-card">
        <div class="fin-card-label">Est. Monthly (21 days)</div>
        <div class="fin-card-value">${fmtCurrency(monthly)}</div>
        <div class="fin-card-sub">Based on active headcount</div>
      </div>
      <div class="fin-card">
        <div class="fin-card-label">Est. Annual (252 days)</div>
        <div class="fin-card-value" style="font-size:20px">${fmtCurrency(annual)}</div>
        <div class="fin-card-sub">If all contracts fully extended</div>
      </div>
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
      <div>
        <div class="section-title" style="font-family:'Syne',sans-serif;font-weight:700;margin-bottom:12px;font-size:16px">Spend by Tribe</div>
        <div class="card">
          <table class="data-table compact">
            <thead><tr><th>Tribe</th><th>Contractors</th><th>Daily</th><th>Monthly Est.</th></tr></thead>
            <tbody>
              ${TRIBES.map(tribe => {
                const tribeSquadIds = squads.filter(s=>s.tribe===tribe.id).map(s=>s.id);
                const tribePeople = active.filter(p=>tribeSquadIds.includes(p.squad));
                const triDaily = tribePeople.reduce((a,p)=>a+p.dayRate,0);
                return `<tr>
                  <td><span style="display:flex;align-items:center;gap:6px"><div style="width:8px;height:8px;border-radius:50%;background:${tribe.color}"></div><strong>${tribe.name}</strong></span></td>
                  <td style="font-family:'JetBrains Mono',monospace">${tribePeople.length}</td>
                  <td style="font-family:'JetBrains Mono',monospace">${fmtCurrency(triDaily)}</td>
                  <td style="font-family:'JetBrains Mono',monospace;color:var(--text-muted)">${fmtCurrency(triDaily*21)}</td>
                </tr>`;
              }).join('')}
            </tbody>
          </table>
        </div>
      </div>
      <div>
        <div class="section-title" style="font-family:'Syne',sans-serif;font-weight:700;margin-bottom:12px;font-size:16px">Spend by Role</div>
        <div class="card">
          <table class="data-table compact">
            <thead><tr><th>Role</th><th>Count</th><th>Avg Rate</th><th>Daily Total</th></tr></thead>
            <tbody>
              ${Object.entries(byRole).sort((a,b)=>b[1].total-a[1].total).map(([role,data])=>`<tr>
                <td>${role}</td>
                <td style="font-family:'JetBrains Mono',monospace">${data.count}</td>
                <td style="font-family:'JetBrains Mono',monospace">${fmtCurrency(Math.round(data.total/data.count))}</td>
                <td style="font-family:'JetBrains Mono',monospace">${fmtCurrency(data.total)}</td>
              </tr>`).join('')}
            </tbody>
          </table>
        </div>
      </div>
    </div>`;
}

// ================================================================
// MODALS
// ================================================================

function openModal(html) {
  document.getElementById('modal-inner').innerHTML = html;
  document.getElementById('modal-overlay').style.display = 'flex';
}

function closeModal() {
  document.getElementById('modal-overlay').style.display = 'none';
}

function closeModalOnOverlay(e) {
  if (e.target === document.getElementById('modal-overlay')) closeModal();
}

// --- Person detail/edit modal ---
function openPersonModal(id) {
  const p = people.find(x=>x.id===id);
  if (!p) return;
  const sq = squads.find(s=>s.id===p.squad);
  openModal(`
    <div class="modal-header">
      <div class="modal-title">${p.name}</div>
      <button class="modal-close" onclick="closeModal()">√ó</button>
    </div>
    <div class="modal-body">
      <div style="display:flex;gap:10px;margin-bottom:18px">
        <span class="badge ${getTypeClass(p.type)}">${getTypeLabel(p.type)}</span>
        <span class="badge badge-grey">${p.role}</span>
        ${sq ? `<span class="badge badge-grey">${sq.name}</span>` : ''}
      </div>
      <div class="form-grid">
        <div class="form-group">
          <div class="form-label">Name</div>
          <input class="form-input" id="pm-name" value="${p.name}" />
        </div>
        <div class="form-group">
          <div class="form-label">Role</div>
          <input class="form-input" id="pm-role" value="${p.role}" />
        </div>
        <div class="form-group">
          <div class="form-label">Type</div>
          <select class="form-select" id="pm-type">
            <option value="perm" ${p.type==='perm'?'selected':''}>Permanent</option>
            <option value="contractor" ${p.type==='contractor'?'selected':''}>Contractor</option>
            <option value="msp" ${p.type==='msp'?'selected':''}>Consultant (MSP)</option>
          </select>
        </div>
        <div class="form-group">
          <div class="form-label">Squad</div>
          <select class="form-select" id="pm-squad">
            ${squads.map(s=>`<option value="${s.id}" ${s.id===p.squad?'selected':''}>${s.name}</option>`).join('')}
          </select>
        </div>
        <div class="form-group">
          <div class="form-label">Day Rate (ex GST)</div>
          <input class="form-input" id="pm-rate" type="number" value="${p.dayRate||''}" placeholder="e.g. 1200" />
        </div>
        <div class="form-group">
          <div class="form-label">Agency</div>
          <input class="form-input" id="pm-agency" value="${p.agency||''}" />
        </div>
        <div class="form-group">
          <div class="form-label">Start Date</div>
          <input class="form-input" id="pm-start" type="date" value="${p.startDate||''}" />
        </div>
        <div class="form-group">
          <div class="form-label">End Date</div>
          <input class="form-input" id="pm-end" type="date" value="${p.endDate||''}" />
        </div>
        <div class="form-group">
          <div class="form-label">Status</div>
          <select class="form-select" id="pm-status">
            <option value="active" ${p.status==='active'?'selected':''}>Active</option>
            <option value="inactive" ${p.status==='inactive'?'selected':''}>Inactive</option>
          </select>
        </div>
        <div class="form-group">
          <div class="form-label">Next Action</div>
          <select class="form-select" id="pm-action">
            <option value="" ${!p.nextAction?'selected':''}>‚Äî None ‚Äî</option>
            <option value="Extend" ${p.nextAction==='Extend'?'selected':''}>Extend</option>
            <option value="Roll Off" ${p.nextAction==='Roll Off'?'selected':''}>Roll Off</option>
            <option value="Convert" ${p.nextAction==='Convert'?'selected':''}>Convert to Perm</option>
            <option value="New Hire" ${p.nextAction==='New Hire'?'selected':''}>New Hire</option>
          </select>
        </div>
        <div class="form-group">
          <div class="form-label">Action Status</div>
          <select class="form-select" id="pm-actstatus">
            <option value="" ${!p.actionStatus?'selected':''}>‚Äî None ‚Äî</option>
            <option value="Approved" ${p.actionStatus==='Approved'?'selected':''}>Approved</option>
            <option value="Awaiting Approval" ${p.actionStatus==='Awaiting Approval'?'selected':''}>Awaiting Approval</option>
            <option value="Pending" ${p.actionStatus==='Pending'?'selected':''}>Pending</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <div class="form-label">Comments</div>
        <textarea class="form-textarea" id="pm-comments">${p.comments||''}</textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-danger" onclick="deletePerson('${p.id}')">Remove Person</button>
      <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" onclick="savePerson('${p.id}')">Save Changes</button>
    </div>`);
}

function savePerson(id) {
  const p = people.find(x=>x.id===id);
  if (!p) return;
  p.name = document.getElementById('pm-name').value;
  p.role = document.getElementById('pm-role').value;
  p.type = document.getElementById('pm-type').value;
  p.squad = document.getElementById('pm-squad').value;
  p.dayRate = parseFloat(document.getElementById('pm-rate').value) || null;
  p.agency = document.getElementById('pm-agency').value || null;
  p.startDate = document.getElementById('pm-start').value || null;
  p.endDate = document.getElementById('pm-end').value || null;
  p.status = document.getElementById('pm-status').value;
  p.nextAction = document.getElementById('pm-action').value || null;
  p.actionStatus = document.getElementById('pm-actstatus').value || null;
  p.comments = document.getElementById('pm-comments').value;
  closeModal();
  renderContent();
  renderSidebar();
}

function deletePerson(id) {
  if (!confirm('Remove this person from the register? This will affect squad capacity calculations.')) return;
  people = people.filter(p => p.id !== id);
  closeModal();
  renderContent();
  renderSidebar();
}

function openAddPersonModal(squadId) {
  openModal(`
    <div class="modal-header">
      <div class="modal-title">Add Person</div>
      <button class="modal-close" onclick="closeModal()">√ó</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group">
          <div class="form-label">Name</div>
          <input class="form-input" id="np-name" placeholder="Full name" />
        </div>
        <div class="form-group">
          <div class="form-label">Role</div>
          <input class="form-input" id="np-role" placeholder="e.g. Senior Engineer" />
        </div>
        <div class="form-group">
          <div class="form-label">Type</div>
          <select class="form-select" id="np-type">
            <option value="perm">Permanent</option>
            <option value="contractor">Contractor</option>
            <option value="msp">Consultant (MSP)</option>
          </select>
        </div>
        <div class="form-group">
          <div class="form-label">Squad</div>
          <select class="form-select" id="np-squad">
            ${squads.map(s=>`<option value="${s.id}" ${s.id===squadId?'selected':''}>${s.name}</option>`).join('')}
          </select>
        </div>
        <div class="form-group">
          <div class="form-label">Day Rate (ex GST)</div>
          <input class="form-input" id="np-rate" type="number" placeholder="e.g. 1200" />
        </div>
        <div class="form-group">
          <div class="form-label">Agency</div>
          <input class="form-input" id="np-agency" placeholder="e.g. AKQA, Iterate" />
        </div>
        <div class="form-group">
          <div class="form-label">Start Date</div>
          <input class="form-input" id="np-start" type="date" />
        </div>
        <div class="form-group">
          <div class="form-label">End Date</div>
          <input class="form-input" id="np-end" type="date" />
        </div>
        <div class="form-group">
          <div class="form-label">Next Action</div>
          <select class="form-select" id="np-action">
            <option value="">‚Äî None ‚Äî</option>
            <option value="Extend">Extend</option>
            <option value="Roll Off">Roll Off</option>
            <option value="Convert">Convert to Perm</option>
            <option value="New Hire">New Hire</option>
          </select>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" onclick="addPerson()">Add to Register</button>
    </div>`);
}

function addPerson() {
  const name = document.getElementById('np-name').value.trim();
  if (!name) { alert('Name is required'); return; }
  const newPerson = {
    id: 'p_' + Date.now(),
    name,
    role: document.getElementById('np-role').value,
    squad: document.getElementById('np-squad').value,
    type: document.getElementById('np-type').value,
    dayRate: parseFloat(document.getElementById('np-rate').value) || null,
    agency: document.getElementById('np-agency').value || null,
    startDate: document.getElementById('np-start').value || null,
    endDate: document.getElementById('np-end').value || null,
    status: 'active',
    nextAction: document.getElementById('np-action').value || null,
    actionStatus: null,
    comments: '',
  };
  people.push(newPerson);
  closeModal();
  renderContent();
  renderSidebar();
}

// --- Add allocation modal ---
function openAddAllocationModal(squadId) {
  openModal(`
    <div class="modal-header">
      <div class="modal-title">Add Initiative Allocation</div>
      <button class="modal-close" onclick="closeModal()">√ó</button>
    </div>
    <div class="modal-body">
      <div class="form-group" style="margin-bottom:14px">
        <div class="form-label">Initiative</div>
        <select class="form-select" id="aa-init">
          ${initiatives.map(i=>`<option value="${i.id}">${i.name} (${getTierLabel(i.tier)})</option>`).join('')}
        </select>
      </div>
      <div class="form-group">
        <div class="form-label">% of squad capacity</div>
        <input class="form-input" id="aa-pct" type="number" min="0" max="100" placeholder="e.g. 25" />
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" onclick="addAllocation('${squadId}')">Add Allocation</button>
    </div>`);
}

function addAllocation(squadId) {
  const initId = document.getElementById('aa-init').value;
  const pct = parseInt(document.getElementById('aa-pct').value);
  if (!initId || isNaN(pct)) { alert('Please select an initiative and enter a %'); return; }
  const init = initiatives.find(i=>i.id===initId);
  if (!init.allocations) init.allocations = {};
  init.allocations[squadId] = pct;
  closeModal();
  renderContent();
  renderSidebar();
}

// --- Add initiative modal ---
function openAddInitiativeModal() {
  openModal(`
    <div class="modal-header">
      <div class="modal-title">New Initiative</div>
      <button class="modal-close" onclick="closeModal()">√ó</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group">
          <div class="form-label">Name</div>
          <input class="form-input" id="ni-name" placeholder="Initiative name" />
        </div>
        <div class="form-group">
          <div class="form-label">Tier</div>
          <select class="form-select" id="ni-tier">
            <option value="1">T1 ‚Äî Program</option>
            <option value="2" selected>T2 ‚Äî Project</option>
            <option value="3">T3 ‚Äî Product</option>
          </select>
        </div>
        <div class="form-group">
          <div class="form-label">Status</div>
          <select class="form-select" id="ni-status">
            <option>Delivery</option>
            <option>Business Case</option>
            <option>Assess</option>
            <option>High Level Design</option>
          </select>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" onclick="addInitiative()">Create Initiative</button>
    </div>`);
}

function addInitiative() {
  const name = document.getElementById('ni-name').value.trim();
  if (!name) { alert('Name is required'); return; }
  initiatives.push({
    id: 'init_' + Date.now(),
    name,
    tier: parseInt(document.getElementById('ni-tier').value),
    status: document.getElementById('ni-status').value,
    owner: 'C&S',
    allocations: {}
  });
  closeModal();
  renderContent();
}

// ================================================================
// ROADMAP & DEMAND CHART ‚Äî DATE DATA
// ================================================================

// Add start/end dates to initiatives for roadmap
// Format: 'YYYY-MM-DD'
const initiativeDates = {
  ppng:       { start: '2025-04-01', end: '2026-09-30' },
  rocket_i:   { start: '2025-01-01', end: '2026-08-31' },
  nzmkt:      { start: '2025-03-01', end: '2026-06-30' },
  nzloy:      { start: '2025-06-01', end: '2026-06-30' },
  tyrewise:   { start: '2025-09-01', end: '2026-04-30' },
  uteboot:    { start: '2025-10-01', end: '2026-05-31' },
  ocean:      { start: '2025-07-01', end: '2026-06-30' },
  stripe:     { start: '2026-01-01', end: '2026-09-30' },
  redsba:     { start: '2025-11-01', end: '2026-05-31' },
  ppecom_i:   { start: '2025-04-01', end: '2026-08-31' },
  retailmfa:  { start: '2025-12-01', end: '2026-04-30' },
  sfcrm_i:    { start: '2025-03-01', end: '2026-06-30' },
  futsch:     { start: '2026-02-01', end: '2026-10-31' },
  loyback:    { start: '2025-07-01', end: '2026-12-31' },
  incident:   { start: '2025-01-01', end: '2026-12-31' },
  apigee:     { start: '2025-06-01', end: '2026-09-30' },
  futcart:    { start: '2026-03-01', end: '2026-09-30' },
  crt:        { start: '2026-04-01', end: '2027-03-31' },
};

// ================================================================
// ROADMAP VIEW
// ================================================================

function renderRoadmap() {
  // Build 14-month window: Jan 2025 ‚Üí Feb 2026 (14 cols)
  const months = [];
  const start = new Date('2025-01-01');
  for (let i = 0; i < 18; i++) {
    const d = new Date(start);
    d.setMonth(start.getMonth() + i);
    months.push(d);
  }

  const totalMonths = months.length;
  const windowStart = months[0];
  const windowEnd = new Date(months[totalMonths - 1]);
  windowEnd.setMonth(windowEnd.getMonth() + 1);

  function monthIndex(dateStr) {
    if (!dateStr) return -1;
    const d = new Date(dateStr);
    return (d.getFullYear() - windowStart.getFullYear()) * 12 + (d.getMonth() - windowStart.getMonth());
  }

  function pct(idx) { return (idx / totalMonths) * 100; }

  const todayIdx = monthIndex(new Date().toISOString().slice(0,10));
  const todayFrac = todayIdx + (new Date().getDate() / 30);
  const todayPct = Math.max(0, Math.min(100, (todayFrac / totalMonths) * 100));

  const TRIBE_COLORS = { web:'#1a5276', range:'#1e8449', app:'#6c3483', cp:'#c17f24' };
  const TIER_BAR_COLORS = {
    1: { bg:'#c0392b', text:'#fff' },
    2: { bg:'#c17f24', text:'#fff' },
    3: { bg:'#1a5276', text:'#fff' },
  };

  // Month header
  let monthHeaders = months.map((m, i) => {
    const isQStart = m.getMonth() % 3 === 0;
    const label = m.toLocaleDateString('en-AU', { month: 'short' });
    const yearLabel = m.getMonth() === 0 ? ` '${String(m.getFullYear()).slice(2)}` : '';
    return `<div class="roadmap-month ${isQStart ? 'quarter-start' : ''}">${label}${yearLabel}</div>`;
  }).join('');

  // Build rows grouped by tribe
  let rows = '';
  TRIBES.forEach(tribe => {
    const tribeInits = initiatives.filter(init => {
      // Belongs to tribe if any allocated squad is in tribe
      return Object.keys(init.allocations||{}).some(sqId => {
        const sq = squads.find(s=>s.id===sqId);
        return sq && sq.tribe === tribe.id;
      }) || tribe.id === 'web' && ['crt','incident','apigee'].includes(init.id);
    });
    if (!tribeInits.length) return;

    // Tribe header row
    rows += `<div class="roadmap-tribe-header">
      <div class="roadmap-tribe-label">
        <div style="width:10px;height:10px;border-radius:50%;background:${tribe.color}"></div>${tribe.name}
      </div>
      <div class="roadmap-tribe-bg"></div>
    </div>`;

    tribeInits.forEach(init => {
      const dates = initiativeDates[init.id];
      const tierColors = TIER_BAR_COLORS[init.tier] || TIER_BAR_COLORS[3];

      let bar = '';
      if (dates) {
        const startIdx = Math.max(0, monthIndex(dates.start));
        const endIdx = Math.min(totalMonths, monthIndex(dates.end) + 1);
        if (endIdx > startIdx) {
          const leftPct = pct(startIdx);
          const widthPct = pct(endIdx - startIdx);
          bar = `<div class="roadmap-bar"
            style="left:${leftPct}%;width:calc(${widthPct}% - 4px);background:${tierColors.bg};color:${tierColors.text};opacity:${init.status==='Delivery'?1:0.6}"
            data-tip="${init.name} ¬∑ ${init.status}"
            onclick="openInitDateModal('${init.id}')">
            ${init.name}
          </div>`;
        }
      }

      // Cell backgrounds
      const cells = months.map((m, i) => {
        const isQStart = m.getMonth() % 3 === 0;
        return `<div class="roadmap-cell ${isQStart?'quarter-start':''}"></div>`;
      }).join('');

      rows += `<div class="roadmap-row">
        <div class="roadmap-row-label">
          <span class="badge ${getTierClass(init.tier)}" style="flex-shrink:0">${init.tier}</span>
          <span title="${init.name}">${init.name}</span>
        </div>
        <div class="roadmap-cells">
          ${cells}
          ${bar}
          <div class="today-line" style="left:${todayPct}%"></div>
        </div>
      </div>`;
    });
  });

  return `
    <div class="section-header">
      <div>
        <div class="section-title">Initiative Roadmap</div>
        <div class="section-sub">All in-flight and planned initiatives across tribes ‚Äî click any bar to edit dates</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <span class="badge badge-tier1">T1 Program</span>
        <span class="badge badge-tier2">T2 Project</span>
        <span class="badge badge-tier3">T3 Product</span>
      </div>
    </div>
    <div class="card roadmap-wrap">
      <div class="roadmap-grid">
        <div class="roadmap-header-row" style="position:relative">
          <div class="roadmap-label-col">Initiative</div>
          <div class="roadmap-timeline">${monthHeaders}</div>
        </div>
        ${rows}
      </div>
    </div>`;
}

// Edit initiative dates modal
function openInitDateModal(id) {
  const init = initiatives.find(i=>i.id===id);
  if (!init) return;
  const dates = initiativeDates[id] || { start:'', end:'' };
  openModal(`
    <div class="modal-header">
      <div class="modal-title">Edit Dates ‚Äî ${init.name}</div>
      <button class="modal-close" onclick="closeModal()">√ó</button>
    </div>
    <div class="modal-body">
      <div style="margin-bottom:14px">
        <span class="badge ${getTierClass(init.tier)}">${getTierLabel(init.tier)}</span>
        <span class="badge ${getStatusClass(init.status)}" style="margin-left:6px">${init.status}</span>
      </div>
      <div class="form-grid-2">
        <div class="form-group">
          <div class="form-label">Start Date</div>
          <input class="form-input" id="id-start" type="month" value="${(dates.start||'').slice(0,7)}" />
        </div>
        <div class="form-group">
          <div class="form-label">End Date</div>
          <input class="form-input" id="id-end" type="month" value="${(dates.end||'').slice(0,7)}" />
        </div>
      </div>
      <div class="form-group">
        <div class="form-label">Status</div>
        <select class="form-select" id="id-status">
          <option ${init.status==='Delivery'?'selected':''}>Delivery</option>
          <option ${init.status==='Business Case'?'selected':''}>Business Case</option>
          <option ${init.status==='Assess'?'selected':''}>Assess</option>
          <option ${init.status==='High Level Design'?'selected':''}>High Level Design</option>
        </select>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveInitDates('${id}')">Save</button>
    </div>`);
}

function saveInitDates(id) {
  const startVal = document.getElementById('id-start').value;
  const endVal = document.getElementById('id-end').value;
  initiativeDates[id] = {
    start: startVal ? startVal + '-01' : '',
    end:   endVal   ? endVal   + '-28' : '',
  };
  const init = initiatives.find(i=>i.id===id);
  if (init) init.status = document.getElementById('id-status').value;
  closeModal();
  renderContent();
}


// ================================================================
// WORK PROFILES  
// Weekly capacity % per initiative across its duration
// workProfiles[initId] = array of weekly % values (index 0 = first week)
// ================================================================

const workProfiles = {};

// Palette shared for initiatives on demand chart
const DEMAND_PALETTE = [
  '#1a5276','#1e8449','#c0392b','#c17f24','#6c3483',
  '#148f77','#d35400','#2980b9','#7d6608','#117a65',
  '#6e2f0e','#1a5276','#512e5f','#0e6655','#7b241c',
  '#1f618d','#1e8449','#9a7d0a','#6e2f0e','#154360'
];

// Which initiatives are currently checked on
const demandVisible = {};

function initDemandVisible() {
  // Default: first 5 initiatives with dates checked on
  let count = 0;
  initiatives.forEach(init => {
    if (initiativeDates[init.id]?.start && count < 5) {
      demandVisible[init.id] = true;
      count++;
    }
  });
}
initDemandVisible();

function getWeeksForInit(initId) {
  const d = initiativeDates[initId];
  if (!d?.start || !d?.end) return 0;
  return Math.max(1, Math.ceil(
    (new Date(d.end).getTime() - new Date(d.start).getTime()) / (7 * 86400000)
  ));
}

function getOrCreateProfile(initId) {
  if (workProfiles[initId]) return workProfiles[initId];
  const weeks = getWeeksForInit(initId);
  if (!weeks) return [];
  // Default: bell curve ‚Äî ramps up, peaks, tapers
  const profile = [];
  for (let w = 0; w < weeks; w++) {
    const t = weeks > 1 ? w / (weeks - 1) : 0.5;
    let pct;
    if (t < 0.2)       pct = Math.round(t / 0.2 * 30);
    else if (t < 0.55) pct = Math.round(30 + (t - 0.2) / 0.35 * 60);
    else               pct = Math.round(90 - (t - 0.55) / 0.45 * 90);
    profile.push(Math.max(5, Math.min(100, pct)));
  }
  workProfiles[initId] = profile;
  return profile;
}

// Get % for a specific calendar date (by week index offset from init start)
function getProfilePctForDate(initId, dateMs) {
  const d = initiativeDates[initId];
  if (!d?.start || !d?.end) return 0;
  const startMs = new Date(d.start).getTime();
  const endMs   = new Date(d.end).getTime();
  if (dateMs < startMs || dateMs > endMs) return 0;
  const weekIdx = Math.floor((dateMs - startMs) / (7 * 86400000));
  const profile = getOrCreateProfile(initId);
  return profile[Math.min(weekIdx, profile.length - 1)] || 0;
}

// ================================================================
// DEMAND CHART VIEW
// ================================================================

function renderDemand() {
  // Build list of initiatives that have dates
  const datable = initiatives.filter(i => initiativeDates[i.id]?.start);

  const initListHTML = datable.map((init, i) => {
    const col = DEMAND_PALETTE[i % DEMAND_PALETTE.length];
    const checked = !!demandVisible[init.id];
    const dates = initiativeDates[init.id];
    const weeks = getWeeksForInit(init.id);
    return `<label style="display:flex;align-items:center;gap:9px;padding:9px 14px;border-bottom:1px solid var(--border);cursor:pointer;transition:background 0.1s" 
        onmouseover="this.style.background='var(--bg)'" onmouseout="this.style.background=''"
        id="dinit-row-${init.id}">
      <input type="checkbox" ${checked ? 'checked' : ''} onchange="toggleDemandInit('${init.id}')"
        style="width:14px;height:14px;accent-color:${col};cursor:pointer;flex-shrink:0">
      <div style="width:10px;height:10px;border-radius:2px;background:${col};flex-shrink:0"></div>
      <div style="flex:1;min-width:0">
        <div style="font-size:12px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" title="${init.name}">${init.name}</div>
        <div style="font-size:10px;color:var(--text-muted);font-family:'JetBrains Mono',monospace">${weeks}w</div>
      </div>
      <button class="btn btn-secondary btn-sm" style="font-size:10px;padding:3px 8px;flex-shrink:0"
        onclick="event.preventDefault();event.stopPropagation();openProfileEditor('${init.id}')">‚úè Profile</button>
    </label>`;
  }).join('');

  setTimeout(drawDemandChart, 0);

  return `
    <div class="section-header">
      <div>
        <div class="section-title">Capacity Demand Chart</div>
        <div class="section-sub">Weekly work profiles per initiative ‚Äî tick to overlay, click ‚úè Profile to edit the shape</div>
      </div>
    </div>

    <div style="display:grid;grid-template-columns:240px 1fr;gap:20px;align-items:start">

      <div>
        <div class="card" style="overflow:hidden">
          <div class="card-header" style="padding:10px 14px;display:flex;justify-content:space-between;align-items:center">
            <div class="card-title" style="font-size:12px">Initiatives</div>
            <div style="display:flex;gap:6px">
              <button class="btn btn-secondary btn-sm" style="font-size:10px" onclick="setAllDemandInits(true)">All</button>
              <button class="btn btn-secondary btn-sm" style="font-size:10px" onclick="setAllDemandInits(false)">None</button>
            </div>
          </div>
          <div style="max-height:500px;overflow-y:auto">
            ${initListHTML || '<div style="padding:16px;color:var(--text-muted);font-size:12px">No initiatives with dates set. Add dates in the Roadmap view.</div>'}
          </div>
        </div>
      </div>

      <div>
        <div class="demand-chart-wrap card" style="padding:16px;margin-bottom:20px">
          <canvas id="demandCanvas"></canvas>
          <div id="demandLegend" class="demand-legend" style="margin-top:12px"></div>
        </div>
        <div style="font-family:'Syne',sans-serif;font-weight:700;font-size:15px;margin-bottom:12px">Peak Collision Analysis</div>
        <div class="card" id="collision-table"></div>
      </div>

    </div>`;
}

function toggleDemandInit(initId) {
  demandVisible[initId] = !demandVisible[initId];
  drawDemandChart();
}

function setAllDemandInits(val) {
  initiatives.filter(i => initiativeDates[i.id]?.start).forEach(i => {
    demandVisible[i.id] = val;
    const cb = document.querySelector(`#dinit-row-${i.id} input`);
    if (cb) cb.checked = val;
  });
  drawDemandChart();
}

function drawDemandChart() {
  const canvas = document.getElementById('demandCanvas');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const wrap = canvas.parentElement;

  // Canvas sizing
  const W = Math.max(400, wrap.clientWidth - 32);
  const H = 360;
  canvas.width  = W;
  canvas.height = H;
  canvas.style.display = 'block';
  canvas.style.width  = '100%';

  const PAD = { top: 32, right: 20, bottom: 48, left: 58 };
  const chartW = W - PAD.left - PAD.right;
  const chartH = H - PAD.top - PAD.bottom;

  // Time window: Jan 2025 ‚Äì Dec 2026 at weekly resolution
  const WIN_START = new Date('2025-01-01').getTime();
  const WIN_END   = new Date('2027-01-01').getTime();
  const WIN_SPAN  = WIN_END - WIN_START;
  const WEEK_MS   = 7 * 86400000;

  // Build weekly ticks
  const weeks = [];
  for (let t = WIN_START; t < WIN_END; t += WEEK_MS) weeks.push(t);
  const N = weeks.length;

  function xOf(ms) { return PAD.left + ((ms - WIN_START) / WIN_SPAN) * chartW; }

  // ---- Background + grid ----
  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#fafaf8';
  ctx.fillRect(PAD.left, PAD.top, chartW, chartH);

  // Horizontal gridlines
  const yTicks = [0, 25, 50, 75, 100];
  ctx.textAlign = 'right';
  ctx.font = '10px JetBrains Mono, monospace';
  yTicks.forEach(v => {
    const y = PAD.top + chartH - (v / 100) * chartH;
    ctx.strokeStyle = v === 100 ? '#c0392b55' : '#e2deda';
    ctx.lineWidth   = v === 100 ? 1.5 : 1;
    ctx.setLineDash(v === 100 ? [5, 4] : []);
    ctx.beginPath(); ctx.moveTo(PAD.left, y); ctx.lineTo(PAD.left + chartW, y); ctx.stroke();
    ctx.setLineDash([]);
    ctx.fillStyle = v === 100 ? '#c0392b' : '#7a776e';
    ctx.fillText(v + '%', PAD.left - 7, y + 3.5);
  });

  // Y axis label
  ctx.save();
  ctx.translate(PAD.left - 42, PAD.top + chartH / 2);
  ctx.rotate(-Math.PI / 2);
  ctx.textAlign = 'center';
  ctx.fillStyle = '#7a776e';
  ctx.font = '10px Lato, sans-serif';
  ctx.fillText('% Squad Capacity', 0, 0);
  ctx.restore();

  // Vertical quarter lines + labels
  const months = [];
  for (let i = 0; i < 24; i++) {
    const d = new Date('2025-01-01');
    d.setMonth(i);
    months.push(d);
  }
  ctx.textAlign = 'center';
  months.forEach(m => {
    if (m.getMonth() % 3 !== 0) return;
    const x = xOf(m.getTime());
    ctx.strokeStyle = '#d4d0ca'; ctx.lineWidth = 1; ctx.setLineDash([]);
    ctx.beginPath(); ctx.moveTo(x, PAD.top); ctx.lineTo(x, PAD.top + chartH); ctx.stroke();
    const lbl = m.toLocaleDateString('en-AU', { month: 'short' }) + (m.getMonth() === 0 ? ' ' + m.getFullYear() : '');
    ctx.fillStyle = '#1a1916'; ctx.font = 'bold 10px JetBrains Mono, monospace';
    ctx.fillText(lbl, x, PAD.top + chartH + 14);
  });

  // Today line
  const todayX = xOf(Date.now());
  if (todayX > PAD.left && todayX < PAD.left + chartW) {
    ctx.strokeStyle = '#c0392b'; ctx.lineWidth = 1.5; ctx.setLineDash([3, 3]);
    ctx.beginPath(); ctx.moveTo(todayX, PAD.top - 4); ctx.lineTo(todayX, PAD.top + chartH); ctx.stroke();
    ctx.setLineDash([]);
    ctx.fillStyle = '#c0392b'; ctx.textAlign = 'left'; ctx.font = 'bold 9px JetBrains Mono, monospace';
    ctx.fillText('Today', todayX + 3, PAD.top + 11);
  }

  // ---- Draw initiative lines ----
  const visInits = initiatives.filter(i => demandVisible[i.id] && initiativeDates[i.id]?.start);
  const legendItems = [];

  visInits.forEach((init, idx) => {
    const col = DEMAND_PALETTE[initiatives.indexOf(init) % DEMAND_PALETTE.length];

    // Build weekly % series
    const vals = weeks.map(wMs => getProfilePctForDate(init.id, wMs));

    // Area fill
    ctx.save();
    ctx.globalAlpha = 0.08;
    ctx.fillStyle = col;
    ctx.beginPath();
    vals.forEach((v, i) => {
      const x = xOf(weeks[i]);
      const y = PAD.top + chartH - (v / 100) * chartH;
      i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
    });
    ctx.lineTo(xOf(weeks[N - 1]), PAD.top + chartH);
    ctx.lineTo(xOf(weeks[0]), PAD.top + chartH);
    ctx.closePath(); ctx.fill(); ctx.restore();

    // Line
    ctx.strokeStyle = col; ctx.lineWidth = 2.5; ctx.lineJoin = 'round'; ctx.setLineDash([]);
    ctx.beginPath();
    let started = false;
    vals.forEach((v, i) => {
      if (v === 0 && !started) return;
      const x = xOf(weeks[i]);
      const y = PAD.top + chartH - (v / 100) * chartH;
      if (!started) { ctx.moveTo(x, y); started = true; }
      else ctx.lineTo(x, y);
    });
    ctx.stroke();

    legendItems.push({ name: init.name, col, initId: init.id });
  });

  // ---- Legend below canvas ----
  const legendEl = document.getElementById('demandLegend');
  if (legendEl) {
    legendEl.innerHTML = legendItems.length
      ? legendItems.map(l => `
          <div class="demand-legend-item" onclick="openProfileEditor('${l.initId}')" style="cursor:pointer" title="Click to edit profile">
            <div class="demand-legend-swatch" style="background:${l.col}"></div>
            <span>${l.name}</span>
          </div>`).join('')
      : '<div style="color:var(--text-muted);font-size:12px">Select initiatives on the left to overlay them</div>';
  }

  // ---- Collision analysis ----
  updateCollisionTable(weeks, visInits);
}

function updateCollisionTable(weeks, visInits) {
  const el = document.getElementById('collision-table');
  if (!el) return;
  if (!visInits || !visInits.length) {
    el.innerHTML = '<div class="empty" style="padding:20px"><div class="empty-icon" style="font-size:20px;margin-bottom:4px">üìä</div><div>Select initiatives to see collision analysis.</div></div>';
    return;
  }

  // Aggregate by month: find weeks in each month, sum peak demand
  const months = [];
  for (let i = 0; i < 24; i++) {
    const d = new Date('2025-01-01'); d.setMonth(i);
    months.push(d);
  }

  const WEEK_MS = 7 * 86400000;
  const collisions = [];
  months.forEach(m => {
    const mEnd = new Date(m); mEnd.setMonth(m.getMonth() + 1);
    // Get all weeks that fall in this month
    const mWeeks = weeks.filter(wMs => wMs >= m.getTime() && wMs < mEnd.getTime());
    if (!mWeeks.length) return;

    // For each initiative, find its peak % in this month
    const initPeaks = visInits.map(init => {
      const peak = Math.max(0, ...mWeeks.map(wMs => getProfilePctForDate(init.id, wMs)));
      return { init, peak };
    }).filter(x => x.peak > 0);

    // Total demand = sum of peaks (rough: all drawing simultaneously at peak)
    const totalDemand = initPeaks.reduce((a, x) => a + x.peak, 0);
    const over85 = initPeaks.filter(x => x.peak > 50); // initiatives contributing meaningfully

    if (totalDemand > 100 || over85.length >= 2) {
      collisions.push({ month: m, totalDemand, contributors: initPeaks.filter(x => x.peak > 20) });
    }
  });

  if (!collisions.length) {
    el.innerHTML = '<div class="empty" style="padding:20px"><div style="font-size:20px;margin-bottom:6px">‚úì</div><div style="color:var(--text-muted)">No months where combined demand exceeds 100% ‚Äî looking clear.</div></div>';
    return;
  }

  el.innerHTML = `<table class="data-table compact">
    <thead><tr><th>Month</th><th>Contributing Initiatives</th><th>Peak Combined Demand</th><th>Risk</th></tr></thead>
    <tbody>${collisions.map(c => {
      const cls = c.totalDemand > 150 ? 'badge-red' : c.totalDemand > 120 ? 'badge-amber' : 'badge-blue';
      const lbl = c.totalDemand > 150 ? 'Critical' : c.totalDemand > 120 ? 'High' : 'Medium';
      return `<tr>
        <td><strong>${c.month.toLocaleDateString('en-AU',{month:'short',year:'numeric'})}</strong></td>
        <td>${c.contributors.map(x=>`<span class="tag">${x.init.name} <strong>${Math.round(x.peak)}%</strong></span>`).join(' ')}</td>
        <td style="font-family:'JetBrains Mono',monospace;color:${c.totalDemand > 100 ? 'var(--red)' : 'inherit'}">${Math.round(c.totalDemand)}%</td>
        <td><span class="badge ${cls}">${lbl}</span></td>
      </tr>`;
    }).join('')}</tbody>
  </table>`;
}

// ================================================================
// PROFILE EDITOR MODAL ‚Äî horizontal canvas bar editor with month slider
// ================================================================

const PRESETS = [
  { name: 'Bell curve', fn: (w, n) => { const t = n>1?w/(n-1):0.5; if(t<0.2) return Math.round(t/0.2*30); if(t<0.55) return Math.round(30+(t-0.2)/0.35*60); return Math.round(90-(t-0.55)/0.45*90); } },
  { name: 'Ramp up',    fn: (w, n) => Math.round((w/(n-1||1))*100) },
  { name: 'Ramp down',  fn: (w, n) => Math.round((1-w/(n-1||1))*100) },
  { name: 'Flat 50%',   fn: () => 50 },
  { name: 'Flat 100%',  fn: () => 100 },
  { name: 'Front-heavy',fn: (w, n) => Math.round(Math.max(5, 100-Math.pow(w/(n-1||1),1.5)*95)) },
];

function openProfileEditor(initId) {
  const init = initiatives.find(i => i.id === initId);
  if (!init) return;
  const dates = initiativeDates[initId];
  const totalWeeks = getWeeksForInit(initId);
  const col = DEMAND_PALETTE[initiatives.indexOf(init) % DEMAND_PALETTE.length];

  if (!totalWeeks) {
    openModal(`<div class="modal-header"><div class="modal-title">No dates set</div><button class="modal-close" onclick="closeModal()">√ó</button></div>
      <div class="modal-body"><p style="padding:8px 0">Set start and end dates for <strong>${init.name}</strong> in the Roadmap view first.</p></div>
      <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">Close</button></div>`);
    return;
  }

  const profile = getOrCreateProfile(initId);

  // How many weeks fit comfortably in the viewport at once
  const VISIBLE_WEEKS = 13; // ~1 quarter
  let scrollOffset = 0; // first visible week index

  openModal(`
    <div class="modal-header">
      <div style="display:flex;align-items:center;gap:10px">
        <div style="width:12px;height:12px;border-radius:3px;background:${col};flex-shrink:0"></div>
        <div class="modal-title">${init.name} ‚Äî Work Profile</div>
      </div>
      <button class="modal-close" onclick="closeModal()">√ó</button>
    </div>
    <div class="modal-body" style="padding:16px 20px">

      <!-- Meta + presets -->
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:14px;flex-wrap:wrap">
        <span style="font-size:11px;color:var(--text-muted);font-family:'JetBrains Mono',monospace;flex-shrink:0">
          ${totalWeeks} weeks &nbsp;¬∑&nbsp; ${new Date(dates.start).toLocaleDateString('en-AU',{month:'short',year:'numeric'})} ‚Üí ${new Date(dates.end).toLocaleDateString('en-AU',{month:'short',year:'numeric'})}
        </span>
        <div style="flex:1"></div>
        <div style="display:flex;gap:5px;flex-wrap:wrap">
          ${PRESETS.map((p,pi) => `<button class="btn btn-secondary btn-sm" style="font-size:10px" onclick="applyProfilePreset_v2('${initId}',${pi})">${p.name}</button>`).join('')}
        </div>
      </div>

      <!-- Canvas editor -->
      <div style="position:relative;background:var(--bg2);border:1px solid var(--border);border-radius:8px;overflow:hidden">
        <canvas id="profileCanvas" style="display:block;width:100%;cursor:crosshair"></canvas>
      </div>

      <!-- Month slider ‚Äî only shown if weeks > VISIBLE_WEEKS -->
      <div id="profile-slider-wrap" style="margin-top:10px;display:${totalWeeks > VISIBLE_WEEKS ? 'flex' : 'none'};align-items:center;gap:10px">
        <button class="btn btn-secondary btn-sm" onclick="profileScroll(-${VISIBLE_WEEKS})">‚óÄ</button>
        <input type="range" id="profile-slider" min="0" max="${Math.max(0, totalWeeks - VISIBLE_WEEKS)}"
          value="0" style="flex:1;accent-color:${col}" oninput="profileScrollTo(parseInt(this.value))">
        <button class="btn btn-secondary btn-sm" onclick="profileScroll(${VISIBLE_WEEKS})">‚ñ∂</button>
        <span id="profile-slider-label" style="font-size:11px;font-family:'JetBrains Mono',monospace;color:var(--text-muted);white-space:nowrap;min-width:80px;text-align:right"></span>
      </div>
      <div style="margin-top:8px;font-size:11px;color:var(--text-muted)">
        Click or drag on bars to set weekly % ‚Äî drag across multiple weeks to draw a shape
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveProfileAndClose('${initId}')">Save & Update Chart</button>
    </div>`);

  // ---- Set up canvas after DOM ready ----
  setTimeout(() => {
    const canvas = document.getElementById('profileCanvas');
    if (!canvas) return;

    const W_PADDED = canvas.parentElement.clientWidth;
    const BAR_H = 160;
    const PAD = { top: 28, right: 12, bottom: 36, left: 42 };
    canvas.width  = W_PADDED;
    canvas.height = BAR_H + PAD.top + PAD.bottom;
    const ctx = canvas.getContext('2d');

    const chartW = canvas.width - PAD.left - PAD.right;
    const chartH = BAR_H;

    function weekX(localIdx) {
      // localIdx = 0..VISIBLE_WEEKS-1
      const visCount = Math.min(VISIBLE_WEEKS, totalWeeks - scrollOffset);
      return PAD.left + (localIdx / visCount) * chartW;
    }
    function barWidth() {
      const visCount = Math.min(VISIBLE_WEEKS, totalWeeks - scrollOffset);
      return Math.max(4, chartW / visCount - 3);
    }
    function weekLabel(weekIdx) {
      const d = new Date(new Date(dates.start).getTime() + weekIdx * 7 * 86400000);
      return 'W' + (weekIdx + 1);
    }
    function monthBoundaryLabel(weekIdx) {
      const d = new Date(new Date(dates.start).getTime() + weekIdx * 7 * 86400000);
      const prev = weekIdx > 0 ? new Date(new Date(dates.start).getTime() + (weekIdx-1) * 7 * 86400000) : null;
      if (!prev || d.getMonth() !== prev.getMonth()) {
        return d.toLocaleDateString('en-AU', { month: 'short', year: '2-digit' });
      }
      return null;
    }

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Background
      ctx.fillStyle = '#f7f6f2';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // Y axis gridlines + labels
      const yTicks = [0, 25, 50, 75, 100];
      ctx.font = '10px JetBrains Mono, monospace';
      yTicks.forEach(v => {
        const y = PAD.top + chartH - (v / 100) * chartH;
        ctx.strokeStyle = v === 100 ? '#c0392b44' : '#e0ddd7';
        ctx.lineWidth = v === 100 ? 1.5 : 1;
        ctx.setLineDash(v === 100 ? [4, 3] : []);
        ctx.beginPath(); ctx.moveTo(PAD.left, y); ctx.lineTo(PAD.left + chartW, y); ctx.stroke();
        ctx.setLineDash([]);
        ctx.fillStyle = v === 100 ? '#c0392b' : '#9a9690';
        ctx.textAlign = 'right';
        ctx.fillText(v + '%', PAD.left - 5, y + 3.5);
      });

      // Bars
      const visCount = Math.min(VISIBLE_WEEKS, totalWeeks - scrollOffset);
      const bw = barWidth();

      for (let li = 0; li < visCount; li++) {
        const wi = scrollOffset + li;
        const pct = profile[wi] || 0;
        const x = weekX(li);
        const barActualH = (pct / 100) * chartH;
        const y = PAD.top + chartH - barActualH;

        // Bar background (empty track)
        ctx.fillStyle = '#e8e5e0';
        ctx.beginPath();
        roundRectPath(ctx, x, PAD.top, bw, chartH, 4);
        ctx.fill();

        // Filled bar
        const barColor = pct > 90 ? '#c0392b' : pct > 70 ? '#c17f24' : col;
        ctx.fillStyle = barColor + 'dd';
        if (barActualH > 0) {
          ctx.beginPath();
          roundRectPath(ctx, x, y, bw, barActualH, 4);
          ctx.fill();
        }

        // % label above bar
        ctx.fillStyle = '#5a5750';
        ctx.textAlign = 'center';
        ctx.font = 'bold 9px JetBrains Mono, monospace';
        ctx.fillText(pct + '%', x + bw / 2, Math.min(y - 3, PAD.top + chartH - 4));

        // Week label below
        ctx.fillStyle = '#9a9690';
        ctx.font = '9px JetBrains Mono, monospace';
        ctx.textAlign = 'center';
        ctx.fillText(weekLabel(wi), x + bw / 2, PAD.top + chartH + 12);

        // Month boundary marker
        const mbl = monthBoundaryLabel(wi);
        if (mbl) {
          ctx.strokeStyle = '#c9c5be';
          ctx.lineWidth = 1;
          ctx.setLineDash([3, 2]);
          ctx.beginPath();
          ctx.moveTo(x - 1, PAD.top);
          ctx.lineTo(x - 1, PAD.top + chartH + 15);
          ctx.stroke();
          ctx.setLineDash([]);
          ctx.fillStyle = '#1a1916';
          ctx.font = 'bold 10px JetBrains Mono, monospace';
          ctx.textAlign = 'left';
          ctx.fillText(mbl, x, PAD.top + chartH + 26);
        }
      }

      // Slider label
      const labelEl = document.getElementById('profile-slider-label');
      if (labelEl && totalWeeks > VISIBLE_WEEKS) {
        const startD = new Date(new Date(dates.start).getTime() + scrollOffset * 7 * 86400000);
        const endIdx = Math.min(scrollOffset + VISIBLE_WEEKS - 1, totalWeeks - 1);
        const endD = new Date(new Date(dates.start).getTime() + endIdx * 7 * 86400000);
        labelEl.textContent = startD.toLocaleDateString('en-AU',{month:'short'}) + ' ‚Äì ' + endD.toLocaleDateString('en-AU',{month:'short',year:'2-digit'});
      }
    }

    function roundRectPath(ctx, x, y, w, h, r) {
      const R = Math.min(r, w/2, h/2);
      ctx.moveTo(x + R, y);
      ctx.lineTo(x + w - R, y);
      ctx.quadraticCurveTo(x + w, y, x + w, y + R);
      ctx.lineTo(x + w, y + h - R);
      ctx.quadraticCurveTo(x + w, y + h, x + w - R, y + h);
      ctx.lineTo(x + R, y + h);
      ctx.quadraticCurveTo(x, y + h, x, y + h - R);
      ctx.lineTo(x, y + R);
      ctx.quadraticCurveTo(x, y, x + R, y);
      ctx.closePath();
    }

    // ---- Hit test: which week index at canvas x? ----
    function weekAtX(canvasX) {
      const visCount = Math.min(VISIBLE_WEEKS, totalWeeks - scrollOffset);
      const bw = barWidth();
      for (let li = 0; li < visCount; li++) {
        const x = weekX(li);
        if (canvasX >= x && canvasX <= x + bw) return scrollOffset + li;
      }
      // Nearest bar
      let best = -1, bestDist = Infinity;
      for (let li = 0; li < visCount; li++) {
        const cx = weekX(li) + bw / 2;
        const d = Math.abs(canvasX - cx);
        if (d < bestDist) { bestDist = d; best = scrollOffset + li; }
      }
      return best;
    }

    function pctAtY(canvasY) {
      const raw = 1 - (canvasY - PAD.top) / chartH;
      return Math.max(0, Math.min(100, Math.round(raw * 100)));
    }

    function canvasPoint(e) {
      const r = canvas.getBoundingClientRect();
      const scaleX = canvas.width / r.width;
      const scaleY = canvas.height / r.height;
      const cx = e.touches ? e.touches[0].clientX : e.clientX;
      const cy = e.touches ? e.touches[0].clientY : e.clientY;
      return { x: (cx - r.left) * scaleX, y: (cy - r.top) * scaleY };
    }

    let painting = false;

    function applyPaint(e) {
      const { x, y } = canvasPoint(e);
      if (y < PAD.top || y > PAD.top + chartH) return;
      const wi = weekAtX(x);
      if (wi < 0 || wi >= totalWeeks) return;
      profile[wi] = pctAtY(y);
      draw();
    }

    canvas.addEventListener('mousedown', e => { painting = true; applyPaint(e); });
    canvas.addEventListener('mousemove', e => { if (painting) applyPaint(e); });
    canvas.addEventListener('mouseup',   () => { painting = false; });
    canvas.addEventListener('mouseleave',() => { painting = false; });
    canvas.addEventListener('touchstart', e => { e.preventDefault(); painting = true; applyPaint(e); }, { passive: false });
    canvas.addEventListener('touchmove',  e => { e.preventDefault(); if (painting) applyPaint(e); }, { passive: false });
    canvas.addEventListener('touchend',   () => { painting = false; });

    // Expose scroll control
    window._profileScroll = (delta) => {
      scrollOffset = Math.max(0, Math.min(totalWeeks - VISIBLE_WEEKS, scrollOffset + delta));
      const slider = document.getElementById('profile-slider');
      if (slider) slider.value = scrollOffset;
      draw();
    };
    window._profileScrollTo = (val) => {
      scrollOffset = Math.max(0, Math.min(totalWeeks - VISIBLE_WEEKS, val));
      draw();
    };

    draw();

  }, 40);
}

function profileScroll(delta)    { if (window._profileScroll)   window._profileScroll(delta); }
function profileScrollTo(val)    { if (window._profileScrollTo) window._profileScrollTo(val); }

function applyProfilePreset_v2(initId, presetIdx) {
  const preset = PRESETS[presetIdx];
  const n = getWeeksForInit(initId);
  workProfiles[initId] = Array.from({ length: n }, (_, w) =>
    Math.max(0, Math.min(100, preset.fn(w, n)))
  );
  // Redraw canvas if open
  const canvas = document.getElementById('profileCanvas');
  if (canvas) {
    // Re-open is simplest; just trigger a redraw via re-open
    const initRef = initiatives.find(i => i.id === initId);
    if (initRef) {
      closeModal();
      setTimeout(() => openProfileEditor(initId), 50);
    }
  }
}

function saveProfileAndClose(initId) {
  closeModal();
  drawDemandChart();
}

// ================================================================
// INLINE ACTIONS
// ================================================================

function updateAlloc(initId, squadId, val) {
  const init = initiatives.find(i=>i.id===initId);
  if (init) { init.allocations[squadId] = parseInt(val)||0; renderContent(); renderSidebar(); }
}

function removeAlloc(initId, squadId) {
  const init = initiatives.find(i=>i.id===initId);
  if (init&&init.allocations) { delete init.allocations[squadId]; renderContent(); renderSidebar(); }
}

function applyScenario() {
  const squadId = document.getElementById('sc-squad').value;
  const type = document.getElementById('sc-type').value;
  const amount = parseFloat(document.getElementById('sc-amount').value)||0;
  const label = document.getElementById('sc-label').value||'Change';
  const sq = squads.find(s=>s.id===squadId);
  let delta = 0;
  if (type==='alloc_add') delta = amount;
  else if (type==='alloc_remove') delta = -amount;
  else if (type==='hire') delta = sq ? (amount/getEffectiveSquadSize(sq.id))*100 : 0;
  else if (type==='lose') delta = sq ? -(amount/getEffectiveSquadSize(sq.id))*100 : 0;
  scenarios.push({ id: Date.now(), squadId, label, delta: Math.round(delta) });
  renderContent();
  renderSidebar();
}

function removeScenario(i) { scenarios.splice(i,1); renderContent(); renderSidebar(); }
function clearScenarios() { scenarios=[]; renderContent(); renderSidebar(); }

// ================================================================
// INIT
// ================================================================


// ================================================================
// PERSISTENCE & AUTH
// ================================================================

let _sessionPassword = null;
let _saveTimer = null;

function getPassword() { return _sessionPassword; }

function collectState() {
  return {
    squads,
    initiatives,
    people,
    initiativeDates,
    workProfiles,
    scenarios,
  };
}

function applyState(data) {
  if (!data) return;
  if (data.squads)         squads         = data.squads;
  if (data.initiatives)    initiatives    = data.initiatives;
  if (data.people)         people         = data.people;
  if (data.initiativeDates) {
    Object.assign(initiativeDates, data.initiativeDates);
  }
  if (data.workProfiles) {
    Object.assign(workProfiles, data.workProfiles);
  }
  if (data.scenarios)      scenarios      = data.scenarios;
}

function scheduleSave() {
  clearTimeout(_saveTimer);
  _saveTimer = setTimeout(persistSave, 1200);
}

async function persistSave() {
  const pw = getPassword();
  if (!pw) return;
  try {
    await fetch('/api/data', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ password: pw, data: collectState() }),
    });
    showSaveIndicator();
  } catch(e) {
    console.warn('Save failed:', e);
  }
}

function showSaveIndicator() {
  let el = document.getElementById('save-indicator');
  if (!el) return;
  el.textContent = '‚úì Saved';
  el.style.opacity = '1';
  clearTimeout(el._fadeTimer);
  el._fadeTimer = setTimeout(() => { el.style.opacity = '0'; }, 2000);
}


// ================================================================
// AUTH SCREEN
// ================================================================

function showAuthScreen() {
  document.getElementById('app-root').style.display = 'none';
  document.getElementById('auth-screen').style.display = 'flex';
  setTimeout(() => document.getElementById('auth-input')?.focus(), 100);
}

function hideAuthScreen() {
  document.getElementById('auth-screen').style.display = 'none';
  document.getElementById('app-root').style.display = 'flex';
}

async function submitAuth() {
  const pw = document.getElementById('auth-input').value.trim();
  const errEl = document.getElementById('auth-error');
  if (!pw) return;

  const btn = document.getElementById('auth-btn');
  btn.textContent = 'Checking‚Ä¶';
  btn.disabled = true;

  try {
    const res = await fetch('/api/auth', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ password: pw }),
    });
    const json = await res.json();
    if (json.ok) {
      _sessionPassword = pw;
      sessionStorage.setItem('cp_pw', pw);
      errEl.style.display = 'none';
      await loadAndInit();
    } else {
      errEl.textContent = 'Incorrect password ‚Äî try again.';
      errEl.style.display = 'block';
      btn.textContent = 'Enter';
      btn.disabled = false;
      document.getElementById('auth-input').value = '';
      document.getElementById('auth-input').focus();
    }
  } catch(e) {
    errEl.textContent = 'Could not reach server. Please refresh.';
    errEl.style.display = 'block';
    btn.textContent = 'Enter';
    btn.disabled = false;
  }
}

async function loadAndInit() {
  try {
    const res = await fetch('/api/data');
    const json = await res.json();
    if (json.data) applyState(json.data);
  } catch(e) {
    console.warn('Could not load saved data, using defaults.');
  }
  hideAuthScreen();
  renderSidebar();
  renderContent();

  // Poll every 30 seconds and merge changes from other users
  if (!window._pollInterval) {
    window._pollInterval = setInterval(async () => {
      try {
        const r = await fetch('/api/data');
        const j = await r.json();
        if (j.data) { applyState(j.data); renderContent(); renderSidebar(); }
      } catch(e) {}
    }, 30000);
  }
}

// ================================================================
// BOOT
// ================================================================

(async function boot() {
  // Try restoring session password from sessionStorage
  const stored = sessionStorage.getItem('cp_pw');
  if (stored) {
    // Verify it's still valid
    try {
      const res = await fetch('/api/auth', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ password: stored }),
      });
      const json = await res.json();
      if (json.ok) {
        _sessionPassword = stored;
        await loadAndInit();
        return;
      }
    } catch(e) { /* fall through to auth screen */ }
  }
  showAuthScreen();
})();

</script>
</body>
</html>
